<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila Assistant - CBC Lesson Plan Generator</title>
    <link rel="stylesheet" href="plans.css">

    <style>
      .floating-message {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #e74c3c;
        color: #fff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;
        animation: slideIn 0.6s ease;
        max-width: 300px;
        line-height: 1.6;
      }

      @keyframes slideIn {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .floating-message a {
        color: #fff;
        text-decoration: underline;
        font-weight: bold;
      }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="../logo.png">
        <h2>Fila Assistant</h2>
    </div>

    <div class="form-container">
        <p><b>Fill in the required fields below To Fetch Lesson Plan</b></p><br>
        <form id="lessonForm">
            <div class="form-grid">

                <div class="form-group">
                    <label class="required">Language</label>
                    <select id="language" required>
                        <option value="">Select Language</option>
                        <option value="english">English</option>
                        <option value="kinyarwanda">Kinyarwanda</option>
                        <option value="kiswahili">Kiswahili</option>
                        <option value="french">French</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="required">School Name</label>
                    <input type="text" id="schoolName" placeholder="e.g: TTC BICUMBI" required>
                </div>

                <div class="form-group">
                    <label class="required">Teacher's Name</label>
                    <input type="text" id="teacherName" placeholder="e.g: IRATURINZE Fils Lambert" required>
                </div>

                <div class="form-group">
                    <label class="required">Term</label>
                    <select id="term" required>
                        <option value="">Select Term</option>
                        <option value="I">Term I</option>
                        <option value="II">Term II</option>
                        <option value="III">Term III</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="required">Date</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label class="required">Subject</label>
                    <input type="text" id="subject" required>
                </div>

                <div class="form-group">
                    <label class="required">Class</label>
                    <input type="text" id="class" required>
                </div>

                <div class="form-group">
                    <label class="required">Unit No</label>
                    <input type="number" id="unitNo" required>
                </div>

                <div class="form-group">
                    <label class="required">Lesson No / Total</label>
                    <div class="double-input">
                        <input type="number" id="lessonNo" required>
                        <input type="number" id="totalLessons" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Duration (minutes)</label>
                    <input type="number" id="duration" required>
                </div>

                <div class="form-group">
                    <label class="required">Class Size</label>
                    <input type="number" id="classSize" required>
                </div>

                <div class="form-group full-width">
                    <label class="required">Unit Title</label>
                    <input type="text" id="unitTitle" required>
                </div>

                <div class="form-group full-width">
                    <label class="required">Lesson Title</label>
                    <input type="text" id="lessonTitle" required>
                </div>

                <div class="form-group full-width">
                    <label class="optional">Teaching Materials (Optional)</label>
                    <input type="text" id="teachingMaterials" placeholder="E.g., Textbook, Flashcards, Worksheets">
                </div>

                <div class="form-group full-width">
                    <label class="optional">Special Educational Needs</label>
                    <input type="text" id="specialNeeds">
                </div>

                <div class="form-group full-width">
                    <label class="optional">References</label>
                    <input type="text" id="references">
                </div>

            </div>

            <button type="submit" class="generate-btn">Fetch Lesson Plan</button>
        </form>
    </div>

    <div id="resultContainer" class="result-container">
        <div class="download-buttons">
    <button class="download-btn btn-word" onclick="copyToWord()">üìÑ Copy to Word</button>
    <button class="download-btn btn-pdf" onclick="window.print()">üìë Print / Save as PDF</button>

    <!-- NEW -->
    <button class="download-btn" id="editBtn" onclick="enableEdit()">‚úèÔ∏è Edit</button>
    <button class="download-btn" id="saveBtn" onclick="saveEdit()" style="display:none;">üíæ Save</button>
        </div>
        <div id="lessonPlanContent" class="lesson-plan"></div>
    </div>
</div>

<div id="floatingMessage" class="floating-message"></div>

<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script>
netlifyIdentity.init();

const user = netlifyIdentity.currentUser();
if (!user) window.location.href = "../login.html";

function showFloatingMessage(msg) {
    const box = document.getElementById("floatingMessage");
    box.innerHTML = msg;
    box.style.display = "block";
    setTimeout(() => box.style.display = "none", 15000);
}

const planFolders = {
    english: "proposals",
    kinyarwanda: "kinyarwanda_plans",
    kiswahili: "kiswahili_plans",
    french: "french_plans"
};

function getRandomPlanFile(language) {
    const index = Math.floor(Math.random() * 5) + 1;
    return `${planFolders[language]}/plan${index}.html`;
}

document.getElementById('lessonForm').addEventListener('submit', async e => {
    e.preventDefault();

    try {
        const res = await fetch(`/.netlify/functions/get-balance?email=${user.email}`);
        const data = await res.json();

        if (!res.ok || data.balance < 1) {
            showFloatingMessage(`‚ùå No lesson plans available.<br><br>
            üëâ <a href="../payment.html">Buy lesson plans</a><br>
            üëâ <a href="../balance.html">View balance</a>`);
            return;
        }

        const deduct = await fetch('/.netlify/functions/use-lesson-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: user.email })
        });

        const deductData = await deduct.json();
        if (!deduct.ok || !deductData.success) {
            showFloatingMessage("‚ùå Failed to deduct lesson plan.");
            return;
        }

        generateLessonPlan();
    } catch {
        showFloatingMessage("‚ùå Server error. Try again.");
    }
});

function generateLessonPlan() {
    const language = document.getElementById('language').value;
    const data = {
        schoolName: schoolName.value,
        teacherName: teacherName.value,
        term: term.value,
        date: date.value,
        subject: subject.value,
        class: document.getElementById('class').value,
        unitNo: unitNo.value,
        lessonNo: lessonNo.value,
        totalLessons: totalLessons.value,
        duration: duration.value,
        classSize: classSize.value,
        unitTitle: unitTitle.value,
        lessonTitle: lessonTitle.value,
        teachingMaterials: teachingMaterials.value || "Not specified",
        specialNeeds: specialNeeds.value || "None",
        references: references.value || "REB Curriculum Guide"
    };

    fetch(getRandomPlanFile(language))
        .then(r => r.text())
        .then(tpl => {
            for (let k in data) tpl = tpl.replaceAll(`{{${k}}}`, data[k]);
            lessonPlanContent.innerHTML = tpl;
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        });
}

function copyToWord() {
    const range = document.createRange();
    range.selectNode(lessonPlanContent);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    alert("Lesson plan copied.");
}
    <script>
function enableEdit() {
    const content = document.getElementById("lessonPlanContent");
    content.contentEditable = "true";
    content.style.border = "2px dashed #3498db";
    content.style.padding = "10px";

    document.getElementById("editBtn").style.display = "none";
    document.getElementById("saveBtn").style.display = "inline-block";
}

function saveEdit() {
    const content = document.getElementById("lessonPlanContent");
    content.contentEditable = "false";
    content.style.border = "none";

    document.getElementById("editBtn").style.display = "inline-block";
    document.getElementById("saveBtn").style.display = "none";

    showFloatingMessage("‚úÖ Lesson plan saved successfully.");
}
</script>
</script>

</body>
    </html>
