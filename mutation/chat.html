<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div class="max-w-3xl mx-auto flex flex-col flex-1 h-screen p-4">
  <h1 id="chatHeader" class="text-2xl font-bold text-blue-700 mb-4"></h1>

  <!-- Chat area -->
  <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-white rounded shadow mb-2"></div>

  <!-- Input area -->
  <div class="flex gap-2">
    <input id="chatInput" class="flex-1 border p-2 rounded" placeholder="Type a message..." />
    <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send</button>
  </div>
</div>

<script>
let myId = localStorage.getItem("userId");
let receiverId = localStorage.getItem("chatReceiverId");
let receiverName = localStorage.getItem("chatReceiverName");

// Set chat header
document.getElementById("chatHeader").textContent = `Chat with ${receiverName}`;

// Load messages
async function loadMessages() {
  const token = localStorage.getItem("auth_token");
  const res = await fetch(`/.netlify/functions/get-messages?receiver_id=${receiverId}`, {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();

  const container = document.getElementById("chatMessages");
  container.innerHTML = data.messages.map(m => 
    `<div class="${m.sender_id === myId ? 'text-right' : 'text-left'} mb-2">
       <span class="inline-block px-3 py-1 rounded ${m.sender_id === myId ? 'bg-green-200' : 'bg-gray-200'}">${m.message}</span>
     </div>`
  ).join("");

  container.scrollTop = container.scrollHeight;
}

// Send message
document.getElementById("sendBtn").addEventListener("click", async () => {
  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if (!message) return;

  const token = localStorage.getItem("auth_token");
  await fetch(`/.netlify/functions/send-message`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ receiver_id: receiverId, message })
  });

  input.value = "";
  loadMessages();
});

// Auto-refresh messages every 3 seconds
setInterval(loadMessages, 3000);
loadMessages();
</script>
</body>
</html>
