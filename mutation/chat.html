<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col" style="height:100dvh;">

  <!-- Header -->
  <header class="bg-white shadow px-4 py-3 flex items-center justify-between flex-shrink-0">
    <h1 id="chatHeader" class="text-lg font-semibold text-blue-700"></h1>
  </header>

  <!-- Messages + Footer wrapper -->
  <div class="flex flex-col flex-1" style="min-height:0;">

    <!-- Messages Area -->
    <main id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3" 
          style="padding-bottom:5rem;"></main> <!-- leave space for footer -->

    <!-- Input Footer -->
    <footer class="bg-white p-2 border-t flex gap-2 flex-shrink-0" 
            style="height:4rem; padding-bottom:env(safe-area-inset-bottom);">
      <textarea 
        id="chatInput"
        rows="1"
        class="flex-1 border rounded-2xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400 resize-none h-full"
        placeholder="Type a message..."
      ></textarea>
      <button 
        id="sendBtn"
        class="bg-blue-600 text-white px-5 py-2 rounded-full hover:bg-blue-700 transition">
        Send
      </button>
    </footer>

  </div>

</body>

<script>
let myId = localStorage.getItem("userId");
let receiverId = localStorage.getItem("chatReceiverId");
let receiverName = localStorage.getItem("chatReceiverName");

document.getElementById("chatHeader").textContent = `Chat with ${receiverName}`;

// Create bubble
function createBubble(message, isMine) {
  const div = document.createElement("div");
  div.className = `flex ${isMine ? "justify-end" : "justify-start"}`;

  const bubble = document.createElement("div");
  bubble.className = `
    max-w-xs px-4 py-2 rounded-2xl shadow
    ${isMine ? "bg-blue-600 text-white rounded-br-none" : "bg-white text-gray-800 rounded-bl-none"}
  `;
  bubble.textContent = message;

  div.appendChild(bubble);
  return div;
}

// Load messages
async function loadMessages() {
  const token = localStorage.getItem("auth_token");
  const res = await fetch(`/.netlify/functions/get-messages?receiver_id=${receiverId}`, {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();
  const container = document.getElementById("chatMessages");
  container.innerHTML = "";

  data.messages.forEach(m => {
    const isMine = String(m.sender_id) === String(myId);
    container.appendChild(createBubble(m.message, isMine));
  });

  container.scrollTop = container.scrollHeight;
}

// Send message
document.getElementById("sendBtn").addEventListener("click", async () => {
  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if (!message) return;

  const token = localStorage.getItem("auth_token");

  await fetch(`/.netlify/functions/send-message`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({
      receiver_id: receiverId,
      message
    })
  });

  input.value = "";
  loadMessages();
});

// Send with Enter key
document.getElementById("chatInput").addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault(); // prevent newline
    document.getElementById("sendBtn").click(); // send
  }
});

// Auto refresh
setInterval(loadMessages, 3000);
loadMessages();
</script>

</body>
  </html>
