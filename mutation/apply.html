<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Teacher Exchange Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-4xl mx-auto p-6">

    <h1 class="text-2xl font-bold text-blue-700 mb-6">Create Your Exchange Profile</h1>

    <form id="wizardForm" class="bg-white rounded-2xl shadow p-6 space-y-6">

        <!-- PAGE 1: Personal Info -->
        <div class="page" id="page1">
            <h2 class="text-xl font-semibold mb-4">Step 1: Personal Information</h2>
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-1">Full Name</label>
                <input type="text" id="full_name" required
                    class="w-full border-gray-300 rounded-lg p-2" />
            </div>
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-1">Phone Number</label>
                <input type="number" id="phone" required
                    class="w-full border-gray-300 rounded-lg p-2" />
            </div>
             
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-1">WhatsApp Number</label>
                <input type="number" id="whatsapp" required
                    class="w-full border-gray-300 rounded-lg p-2" />
                <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-1"> Your Current School</label>
                <input type="text" id="current_school" required
                    class="w-full border-gray-300 rounded-lg p-2" />
                </div>
                <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-1"> Email</label>
                <input type="text" id="email" required
                    class="w-full border-gray-300 rounded-lg p-2" />
                </div>
                <!-- Current Location -->
            </div>

            <div class="flex justify-end">
                <button type="button" onclick="nextPage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                    Next
                </button>
            </div>
        </div>

        <!-- PAGE 2: Preferred Locations -->
      
        <div class="page hidden" id="page2">
            <h2 class="text-xl font-semibold mb-4">Step 2: Current School Locations</h2>
  <div class="mb-4">
    <label class="block font-medium text-gray-700 mb-1"> Current School Province</label>
    <select id="current_province" class="w-full border-gray-300 rounded-lg p-2" onchange="loadCurrentDistricts()" required></select>
</div>
<div class="mb-4">
    <label class="block font-medium text-gray-700 mb-1">Current School District</label>
    <select id="current_district" class="w-full border-gray-300 rounded-lg p-2" onchange="loadCurrentSectors()" required></select>
</div>
<div class="mb-4">
    <label class="block font-medium text-gray-700 mb-1">Current School Sector</label>
    <select id="current_sector" class="w-full border-gray-300 rounded-lg p-2" required></select>
        
</div>
            <div class="flex justify-between">
                <button type="button" onclick="prevPage()"
                    class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    Back
                </button>
                <button type="button" onclick="nextPage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                    Next
                </button>
            </div>
        </div>
        <!-- PAGE 2: preferred school Locations -->
        
        <div class="page hidden" id="page3">
            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Province(s)</label>
                    <select id="preferred_provinces" multiple class="w-full border-gray-300 rounded-lg p-2"
                        onchange="loadPreferredDistricts()"></select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">District(s)</label>
                    <select id="preferred_districts" multiple class="w-full border-gray-300 rounded-lg p-2"
                        onchange="loadPreferredSectors()"></select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Sector(s)</label>
                    <select id="preferred_sectors" multiple class="w-full border-gray-300 rounded-lg p-2"></select>
                </div>
            </div>
<div class="flex justify-between">
                <button type="button" onclick="prevPage()"
                    class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    Back
                </button>
                <button type="button" onclick="nextPage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                    Next
                </button>
            </div>
        </div>
            

        <!-- PAGE 4: Positions -->
        <div class="page hidden" id="page4">
            <h2 class="text-xl font-semibold mb-4">Step 4: Teacher Positions / Qualifications</h2>

            <div id="positionsContainer" class="grid md:grid-cols-2 gap-4 max-h-96 overflow-y-auto mb-4">
                <!-- Positions checkboxes will load here -->
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="prevPage()"
                    class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    Back
                </button>
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">
                    Submit Profile
                </button>
            </div>
        </div>

    </form>

</div>
    <!-- Toast container -->
    
<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity duration-300"></div>

<script src="rwandaLocations.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    // ✅ Read authentication from localStorage
    const token = localStorage.getItem("auth_token");
const userEmail = localStorage.getItem("user_email");
const userId = localStorage.getItem("userId");

if (!token || !userEmail || !userId) {
    window.location.href = "/login.html";
}
    // ✅ Prefill form fields if data exists in localStorage
    const fullName = localStorage.getItem("full_name");
    const phone = localStorage.getItem("phone");
    const whatsapp = localStorage.getItem("whatsapp");
    const currentSchool = localStorage.getItem("current_school");
    const currentProvince = localStorage.getItem("current_province");
    const currentDistrict = localStorage.getItem("current_district");
    const currentSector = localStorage.getItem("current_sector");

    if (fullName) document.getElementById("full_name").value = fullName;
    if (phone) document.getElementById("phone").value = phone;
    if (whatsapp) document.getElementById("whatsapp").value = whatsapp;
    if (currentSchool) document.getElementById("current_school").value = currentSchool;

    // For selects, wait for options to load before setting values
    function setSelectValue(selectId, value) {
        const select = document.getElementById(selectId);
        if (select && value) {
            // Wait until options are loaded
            const interval = setInterval(() => {
                if (Array.from(select.options).some(o => o.value === value)) {
                    select.value = value;
                    clearInterval(interval);
                    // Trigger change if needed to load dependent selects
                    select.dispatchEvent(new Event('change'));
                }
            }, 100);
        }
    }

    setSelectValue("current_province", currentProvince);
    setSelectValue("current_district", currentDistrict);
    setSelectValue("current_sector", currentSector);

});
// --------------------- MULTI-PAGE WIZARD ---------------------
let currentPage = 1;
const totalPages = 4;

function showPage(page) {
    for (let i = 1; i <= totalPages; i++) {
        document.getElementById("page" + i).classList.add("hidden");
    }
    document.getElementById("page" + page).classList.remove("hidden");
}

function nextPage() {
    if (currentPage === 1) {
        // Validate personal info + current location
        if (!document.getElementById("full_name").value ||
            !document.getElementById("phone").value ||
            !document.getElementById("whatsapp").value ||
            !document.getElementById("email").value)
            
        {
            showToast("Please fill all personal information fields.");
            return;
        }
    }
      if (currentPage === 2) {
        if (!currProv.value || !currDist.value || !currSect.value) {
            showToast("Please select your current location (province, district, sector).");
            return;
        }
    }

    if (currentPage === 3) {
        // Validate preferred locations
        if (prefProv.selectedOptions.length === 0 || prefDist.selectedOptions.length === 0) {
            showToast("Please select at least one preferred province and district.");
            return;
        }
    }

    if (currentPage < totalPages) currentPage++;
    showPage(currentPage);
    }
function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
    }
    }
// --------------------- PREFERRED LOCATIONS LOGIC ---------------------
const prefProv = document.getElementById("preferred_provinces");
const prefDist = document.getElementById("preferred_districts");
const prefSect = document.getElementById("preferred_sectors");

function loadPreferredProvinces() {
    prefProv.innerHTML = '';
    Object.keys(RWANDA_LOCATIONS).forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.text = p;
        prefProv.add(opt);
    });
}

function loadPreferredDistricts() {
    prefDist.innerHTML = '';
    prefSect.innerHTML = '';
    Array.from(prefProv.selectedOptions).forEach(prov => {
        Object.keys(RWANDA_LOCATIONS[prov.value]).forEach(d => {
            if (!Array.from(prefDist.options).some(o => o.value === d)) {
                const opt = document.createElement("option");
                opt.value = d;
                opt.text = d;
                prefDist.add(opt);
            }
        });
    });
}

function loadPreferredSectors() {
    prefSect.innerHTML = '';
    Array.from(prefDist.selectedOptions).forEach(distOpt => {
        const provs = Array.from(prefProv.selectedOptions).map(o => o.value);
        provs.forEach(prov => {
            if (RWANDA_LOCATIONS[prov][distOpt.value]) {
                RWANDA_LOCATIONS[prov][distOpt.value].forEach(sec => {
                    if (!Array.from(prefSect.options).some(o => o.value === sec)) {
                        const opt = document.createElement("option");
                        opt.value = sec;
                        opt.text = sec;
                        prefSect.add(opt);
                    }
                });
            }
        });
    });
}

// Initialize provinces on load
loadPreferredProvinces();
    // Current Location selects
const currProv = document.getElementById("current_province");
const currDist = document.getElementById("current_district");
const currSect = document.getElementById("current_sector");

function loadCurrentProvinces() {
    currProv.innerHTML = '';
    Object.keys(RWANDA_LOCATIONS).forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.text = p;
        currProv.add(opt);
    });
}

function loadCurrentDistricts() {
    currDist.innerHTML = '';
    currSect.innerHTML = '';
    const selectedProv = currProv.value;
    if (!selectedProv) return;
    Object.keys(RWANDA_LOCATIONS[selectedProv]).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.text = d;
        currDist.add(opt);
    });
}

function loadCurrentSectors() {
    currSect.innerHTML = '';
    const selectedProv = currProv.value;
    const selectedDist = currDist.value;
    if (!selectedProv || !selectedDist) return;
    RWANDA_LOCATIONS[selectedProv][selectedDist].forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec;
        opt.text = sec;
        currSect.add(opt);
    });
}

// Initialize current province on page load
loadCurrentProvinces();

// --------------------- TEACHER POSITIONS ---------------------
const positions = [
  // A0, A1, A2 from your array
      // A2 Level (Teacher Training College)
  {
    "level": "A2",
    "title": "Languages Teacher A2"
  },
  {
    "level": "A2",
    "title": "Pre-Primary and Lower Primary Teacher A2"
  },
  {
    "level": "A2",
    "title": "Science and Mathematics Teacher A2"
  },
  {
    "level": "A2",
    "title": "Social and Religious Studies  Teacher A2"
},

  // A0 Level (Bachelor's Degree)
  {
    "level": "A0",
    "title": "English and French Teacher"
  },
  {
    "level": "A0",
    "title": "English and Kiswahili Teacher"
  },
  {
    "level": "A0",
    "title": "English and Kinyarwanda Teacher"
  },
  {
    "level": "A0",
    "title": "English and Literature in English Teacher"
  },
  {
    "level": "A0",
    "title": "Literature in English Teacher"
  },
  {
    "level": "A0",
    "title": "English Teacher"
  },
  {
    "level": "A0",
    "title": "Kinyarwanda and Literature in English Teacher"
  },
  {
    "level": "A0",
    "title": "Kinyarwanda Teacher"
  },
  {
    "level": "A0",
    "title": "French and English Teacher"
  },
  {
    "level": "A0",
    "title": "Kiswahili Teacher"
  },
  {
    "level": "A0",
    "title": "Mathematics and Physics Teacher"
  },
  {
    "level": "A0",
    "title": "Mathematics and Chemistry Teacher"
  },
  {
    "level": "A0",
    "title": "Mathematics Teacher"
  },
  {
    "level": "A0",
    "title": "Physics and Biology Teacher"
  },
  {
    "level": "A0",
    "title": "Physics Teacher"
  },
  {
    "level": "A0",
    "title": "Geography and Economics Teacher"
  },
  {
    "level": "A0",
    "title": "Geography and Sport Teacher"
  },
  {
    "level": "A0",
    "title": "Geography and History Teacher"
  },
  {
    "level": "A0",
    "title": "Entrepreneurship and Economics Teacher"
  },
  {
    "level": "A0",
    "title": "Economics Teacher"
  },
  {
    "level": "A0",
    "title": "Psychology Teacher"
  },
  {
    "level": "A0",
    "title": "Creative Performance Teacher"
  },
  {
    "level": "A0",
    "title": "Biology and Chemistry Teacher"
  },
  {
    "level": "A0",
    "title": "Biology and Mathematics"
  },
  {
    "level": "A0",
    "title": "Physical Education and Sport Teacher"
  },
  {
    "level": "A0",
    "title": "Inclusive and Special Needs Education Teacher"
  },
  {
    "level": "A0",
    "title": "Mathematics and ICT Teacher"
  },
  {
    "level": "A0",
    "title": "ICT Teacher"
  },

  // A1 Level (Advanced Diploma)
  {
    "level": "A1",
    "title": "English and French Teacher"
  },
  {
    "level": "A1",
    "title": "English and Kiswahili Teacher"
  },
  {
    "level": "A1",
    "title": "English and Kinyarwanda Teacher"
  },
  {
    "level": "A1",
    "title": "English Teacher"
  },
  {
    "level": "A1",
    "title": "Literature in English Teacher"
  },
  {
    "level": "A1",
    "title": "English and Swahili Teacher"
  },
  {
    "level": "A1",
    "title": "Mathematics and Physics Teacher"
  },
  {
    "level": "A1",
    "title": "Physics and Biology Teacher"
  }
]

const posContainer = document.getElementById("positionsContainer");
positions.forEach(pos => {
    const div = document.createElement("div");
    div.className = "flex items-center";
    div.innerHTML = `
    <input type="radio" name="position" value="${pos.title}" class="mr-2">
    <label class="text-gray-700">${pos.title} (${pos.level})</label>
`;
    posContainer.appendChild(div);
});
    function showToast(message, type = "info") {
    const toast = document.getElementById("toast");
    toast.textContent = message;

    // Change color based on type
    switch(type) {
        case "success":
            toast.className = "fixed bottom-6 right-6 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300";
            break;
        case "error":
            toast.className = "fixed bottom-6 right-6 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300";
            break;
        case "warning":
            toast.className = "fixed bottom-6 right-6 bg-yellow-500 text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300";
            break;
        default:
            toast.className = "fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300";
    }

    // Show toast
    toast.classList.remove("opacity-0");
    toast.classList.add("opacity-100");

    // Hide after 3 seconds
    setTimeout(() => {
        toast.classList.remove("opacity-100");
        toast.classList.add("opacity-0");
    }, 3000);
    }

// --------------------- FORM SUBMISSION ---------------------
document.getElementById("wizardForm").addEventListener("submit", async e => {
    e.preventDefault();

    // --------------------- VALIDATION ---------------------
    const fullName = document.getElementById("full_name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const currentProvince = currProv.value;
    const currentDistrict = currDist.value;
    const currentSector = currSect.value;
    const preferredProvinces = Array.from(prefProv.selectedOptions).map(o => o.value);
    const preferredDistricts = Array.from(prefDist.selectedOptions).map(o => o.value);
    const preferredSectors = Array.from(prefSect.selectedOptions).map(o => o.value);
    const positionSelected = document.querySelector('input[name="position"]:checked')?.value;
    const currentSchool = document.getElementById("current_school").value.trim();

    // Prefill email from localStorage if it exists
    const savedEmail = localStorage.getItem("user_email");
    if (savedEmail) document.getElementById("email").value = savedEmail;

    // Read the email user may have changed
    const newEmail = document.getElementById("email").value.trim();
    localStorage.setItem("user_email", newEmail);

    // Weak userId from localStorage (if you want)
    //const userId = localStorage.getItem("userId");
    //console.log("Submitting profile for userId:", userId);

    // --- Validate Personal Info ---
    if (!fullName || !phone || !whatsapp || !newEmail || !currentSchool) {
        showToast("Please fill all personal information fields.");
        currentPage = 1;
        showPage(currentPage);
        return;
    }

    if (!currentProvince || !currentDistrict || !currentSector) {
        showToast("Please select your current location (province, district, sector).");
        currentPage = 1;
        showPage(currentPage);
        return;
    }

    if (preferredProvinces.length === 0 || preferredDistricts.length === 0) {
        showToast("Please select at least one preferred province and district.");
        currentPage = 2;
        showPage(currentPage);
        return;
    }

    if (!positionSelected) {
        showToast("Please select your qualification.");
        currentPage = 3;
        showPage(currentPage);
        return;
    }

    // --------------------- PREPARE DATA ---------------------
    const data = {
        full_name: fullName,
        phone: phone,
        whatsapp: whatsapp,
        email: newEmail,          // use the updated email
        current_school: currentSchool,
        current_province: currentProvince,
        current_district: currentDistrict,
        current_sector: currentSector,
        preferred_provinces: preferredProvinces,
        preferred_districts: preferredDistricts,
        preferred_sectors: preferredSectors,
        position: positionSelected,
        //userId: userId       // optional weak link to auth DB
    };

    // --------------------- SEND REQUEST ---------------------
    try {
        const res = await fetch("/.netlify/functions/createProfile", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("auth_token")
            },
            body: JSON.stringify(data)
        });

        const result = await res.json();

        if (!res.ok) {
            showToast(result.message || "Failed to register your profile. Please try again.");
            return;
        }

        showToast(result.message || "Profile created successfully");
        window.location.href = "dashboard.html";

    } catch (err) {
        console.error(err);
        showToast("Error connecting to server. Please check your internet and try again.");
    }
});
showPage(currentPage);
</script>

</body>
    </html>
