<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chats with Teachers</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow px-4 py-3 flex items-center justify-between">
    <h1 class="text-xl font-semibold text-blue-700">Chats with Teachers</h1>
    <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Refresh</button>
  </header>

  <!-- Teachers list container -->
  <main id="teachersContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
    <p id="loadingText" class="text-gray-500">Loading chats...</p>
  </main>

  <script>
    // Ensure we have our logged-in userId
// Get elements
const teachersContainer = document.getElementById("teachersContainer");
const loadingText = document.getElementById("loadingText");
const refreshBtn = document.getElementById("refreshBtn");

// Your loadChats function stays the same
async function loadChats() {
  teachersContainer.innerHTML = '';
  loadingText.textContent = "Loading chats...";
  teachersContainer.appendChild(loadingText);

  const token = localStorage.getItem("auth_token"); // your auth token

  try {
    const res = await fetch(`/.netlify/functions/get-chats`, {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();

    loadingText.remove();

    if (!data.teachers || data.teachers.length === 0) {
      teachersContainer.innerHTML = '<p class="text-gray-500">No chats found yet.</p>';
      return;
    }

    data.teachers.forEach(t => {
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded shadow hover:shadow-md transition cursor-pointer flex justify-between items-center";

      const info = document.createElement("div");
      info.innerHTML = `
        <p class="font-semibold text-blue-700">${t.name}</p>
        <p class="text-gray-500 text-sm">${t.last_message ? t.last_message.slice(0,50) : 'No messages yet...'}</p>
      `;

      const time = document.createElement("span");
      time.className = "text-gray-400 text-sm";
      if (t.last_message_at) {
        time.textContent = new Date(t.last_message_at).toLocaleString();
      }

      card.appendChild(info);
      card.appendChild(time);

      // Navigate to chat when clicked
      card.addEventListener("click", () => {
        localStorage.setItem("chatReceiverId", t.auth_user_id);
        localStorage.setItem("chatReceiverName", t.name);
        window.location.href = "chat.html";
      });

      teachersContainer.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    teachersContainer.innerHTML = '<p class="text-red-500">Failed to load chats.</p>';
  }
}

// ---------- Ensure userId exists ----------
let myId = localStorage.getItem("userId");

if (!myId) {
  const token = localStorage.getItem("auth_token");
  if (token) {
    fetch("/.netlify/functions/getTeacherProfile", {
      headers: { "Authorization": "Bearer " + token }
    })
    .then(res => res.json())
    .then(data => {
      myId = data.profile.auth_user_id;
      localStorage.setItem("userId", myId);
      // Load chats after userId is ready
      loadChats();
    })
    .catch(err => {
      console.error("Failed to fetch profile:", err);
      teachersContainer.innerHTML = '<p class="text-red-500">Cannot load chats. Try logging in again.</p>';
    });
  } else {
    teachersContainer.innerHTML = '<p class="text-red-500">Not logged in.</p>';
  }
} else {
  // userId already exists
  loadChats();
}

// Refresh button
refreshBtn.addEventListener("click", loadChats);
    </script>

</body>
</html>
