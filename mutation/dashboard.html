<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Swap Matches</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold text-blue-700 mb-6">Swap Matches Dashboard</h1>
  <div id="myProfileCard" class="bg-white p-6 rounded-xl shadow mb-6 hidden">
  <h2 class="text-xl font-bold text-blue-700 mb-2">My Profile</h2>
  <p id="myName"></p>
  <p id="mySchool"></p>
  <p id="myLocation"></p>
  <p id="myPosition"></p>
  <p id="myPreferences" class="text-sm text-gray-600 mt-2"></p>
  </div>
  <div id="matchesContainer" class="grid gap-4"></div>
</div>
  

<!-- Teacher Details Modal -->
<div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6 relative">
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
    <h2 id="modalName" class="text-xl font-semibold mb-2"></h2>
    <p id="modalSchool" class="mb-1"></p>
    <p id="modalLocation" class="mb-1"></p>
    <p id="modalPosition" class="mb-4"></p>
    <p id="modalContact" class="text-gray-600 text-sm"></p>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity duration-300"></div>

<script>
// ---------- Logged-in Teacher ----------
let myId = null;
let matches = [];

// ---------- Render Matches ----------
  function renderMatches() {
  const container = document.getElementById("matchesContainer");
  container.innerHTML = "";

  // ---------- Add summary ----------
  // Collect all unique positions from matches
  const positions = [...new Set(matches.map(t => t.position))]; // e.g. ["Math", "English"]

  // Build a readable string
  const positionsStr = positions.length ? positions.join(", ") : "teachers";

  // Then use it in the summary
  const summary = document.createElement("p");
  summary.className = "text-gray-700 font-medium mb-4 col-span-full";
  summary.textContent = `We found ${matches.length} ${positionsStr} who match your permutation criteria. Request them to swap, and send them a message.`;
  container.appendChild(summary);

  if (!matches.length) {
    const msg = document.createElement("p");
    msg.className = "text-gray-600";
    msg.textContent = "No matching teachers found.";
    container.appendChild(msg);
    return;
  }

  matches.forEach(t => {
    const div = document.createElement("div");
    div.className = "bg-white p-4 rounded-lg shadow flex justify-between items-center mb-4";

    // ---------- Determine buttons ----------
    let buttonsHTML = "";

    if (t.swap_status === "pending" && t.requester_id === myId) {
      // You sent the request ‚Üí show Requested
      buttonsHTML = `<button class="bg-gray-400 cursor-not-allowed px-3 py-1 rounded">Requested</button>`;
    } else if (t.swap_status === "pending" && t.requester_id !== myId) {
      // Someone sent you a request ‚Üí show Accept/Reject
      buttonsHTML = `
        <button onclick="handleSwapResponse('${t.auth_user_id}', true, this)" class="bg-green-600 px-3 py-1 rounded text-white hover:bg-green-700">‚úÖ Accept</button>
        <button onclick="handleSwapResponse('${t.auth_user_id}', false, this)" class="bg-red-600 px-3 py-1 rounded text-white hover:bg-red-700">‚ùå Reject</button>
      `;
    } else {
      // Normal request button
      buttonsHTML = `<button onclick="requestSwap('${t.auth_user_id}', this)" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Request Swap</button>`;
    }

    // ---------- Build card ----------
    div.innerHTML = `
      <div>
        <p class="font-semibold text-lg">${t.full_name}</p>
        <p class="text-gray-700">${t.current_school} - ${t.current_sector}, ${t.current_district}, ${t.current_province}</p>
        <p class="text-gray-700">Qualification: ${t.position}</p>
        <p class="text-sm text-gray-500">Swap Status: <span class="font-medium">${t.swap_status}</span></p>
      </div>
      <div class="flex gap-2">
        ${buttonsHTML}
        <button onclick="viewTeacher('${t.auth_user_id}')" class="text-blue-600 hover:underline">üëÅÔ∏è View</button>
        <button onclick="openChat('${t.auth_user_id}')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">üí¨ Chat</button>
      </div>
    `;

    container.appendChild(div);
  });
}

// ---------- Handle Accept/Reject ----------
async function handleSwapResponse(requesterId, accept, buttonElem) {
  try {
    const token = localStorage.getItem("auth_token");

    const res = await fetch(`/.netlify/functions/respond-swap`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        requester_id: requesterId,
        requested_id: myId,
        accept: accept
      })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.message || "Failed to respond");

    // Update matches array
    const t = matches.find(m => String(m.auth_user_id) === String(requesterId));
    if (t) t.swap_status = accept ? "accepted" : "rejected";

    // Update UI
    buttonElem.parentElement.innerHTML = `<span class="font-medium ${accept ? "text-green-600" : "text-red-600"}">${accept ? "Accepted ‚úÖ" : "Rejected ‚ùå"}</span>`;

    showToast(`Swap ${accept ? "accepted" : "rejected"} successfully`, "success");
  } catch (err) {
    console.error(err);
    showToast(err.message, "error");
  }
    }

function openChat(receiverId) {
  // Ensure matches are loaded
  if (!matches || !matches.length) {
    showToast("Matches not loaded yet. Try again in a moment.", "error");
    return;
  }

  // Convert both to string to avoid type mismatch
  const teacher = matches.find(t => String(t.auth_user_id) === String(receiverId));

  if (!teacher) {
    showToast("Teacher not found in current matches.", "error");
    return;
  }

  // Store ID and Name
  localStorage.setItem("chatReceiverId", teacher.auth_user_id);
  localStorage.setItem("chatReceiverName", teacher.full_name);

  // Redirect to chat page
  window.location.href = "./chat.html";
  }
// ---------- Fetch Matches ----------
async function fetchMatches() {
  try {
    const token = localStorage.getItem("auth_token");

const res = await fetch(`/.netlify/functions/get-matches`, {
  headers: {
    "Authorization": "Bearer " + token
  }
});
    const data = await res.json();
    matches = data.matches || [];
    renderMatches();
  } catch (err) {
    console.error(err);
    showToast("Failed to load matches", "error");
  }
}

// ---------- View Teacher Modal ----------
function viewTeacher(id) {
  const t = matches.find(m => m.auth_user_id === id);
  if (!t) return;

  document.getElementById("modalName").textContent = t.full_name;
  document.getElementById("modalSchool").textContent = `School: ${t.current_school}`;
  document.getElementById("modalLocation").textContent = `Location: ${t.current_sector}, ${t.current_district}, ${t.current_province}`;
  document.getElementById("modalPosition").textContent = `Qualification: ${t.position}`;
  document.getElementById("modalContact").textContent = `Contact: ${t.contact}`;

  document.getElementById("teacherModal").classList.remove("hidden");
  document.getElementById("teacherModal").classList.add("flex");
}
function closeModal() {
  document.getElementById("teacherModal").classList.add("hidden");
  document.getElementById("teacherModal").classList.remove("flex");
}

// ---------- Request Swap ----------
async function requestSwap(requestedAuthId, buttonElem) {
  try {
    const token = localStorage.getItem("auth_token"); // Get JWT

    const res = await fetch(`/.netlify/functions/request-swap`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token // MUST HAVE
      },
      body: JSON.stringify({ requester_id: myId, requested_id: requestedAuthId })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.message || "Failed to send swap request");

    // Update matches array
    const t = matches.find(m => String(m.auth_user_id) === String(requestedAuthId));
    if (t) t.swap_status = "pending";

    // Update button immediately
    if (buttonElem) {
      buttonElem.textContent = "Requested";
      buttonElem.disabled = true;
      buttonElem.classList.remove("bg-green-600", "hover:bg-green-700");
      buttonElem.classList.add("bg-gray-400", "cursor-not-allowed");
    }

    showToast("Swap requested successfully", "success");

  } catch (err) {
    console.error(err);
    showToast(err.message, "error");
  }
  }
function displayMyProfile(profile) {
  document.getElementById("myName").textContent =
    "Name: " + profile.full_name;

  document.getElementById("mySchool").textContent =
    "School: " + profile.current_school;

  document.getElementById("myLocation").textContent =
    "Location: " +
    profile.current_sector + ", " +
    profile.current_district + ", " +
    profile.current_province;

  document.getElementById("myPosition").textContent =
    "Qualification: " + profile.position;

  // Format preferred locations separately
  const provincesArray = Array.isArray(profile.preferred_provinces)
  ? profile.preferred_provinces
  : JSON.parse(profile.preferred_provinces || "[]");

const districtsArray = Array.isArray(profile.preferred_districts)
  ? profile.preferred_districts
  : JSON.parse(profile.preferred_districts || "[]");

const sectorsArray = Array.isArray(profile.preferred_sectors)
  ? profile.preferred_sectors
  : JSON.parse(profile.preferred_sectors || "[]");

const provinces = provincesArray.length ? provincesArray.join(", ") : "None";
const districts = districtsArray.length ? districtsArray.join(", ") : "None";
const sectors = sectorsArray.length ? sectorsArray.join(", ") : "None";
  document.getElementById("myPreferences").innerHTML =
    `<strong>Preferred Provinces:</strong> ${provinces}<br>
     <strong>Preferred Districts:</strong> ${districts}<br>
     <strong>Preferred Sectors:</strong> ${sectors}`;

  document.getElementById("myProfileCard").classList.remove("hidden");
  }
// ---------- Toast ----------
function showToast(message, type="info") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  const colors = {
    success: "bg-green-600",
    error: "bg-red-600",
    warning: "bg-yellow-500",
    info: "bg-gray-800"
  };
  toast.className = `fixed bottom-6 right-6 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300`;
  setTimeout(() => {
    toast.classList.add("opacity-0");
  }, 3000);
}

// ---------- Initialize ----------
  fetchMatches();
</script>
<script>
(async function () {
  const token = localStorage.getItem("auth_token");

  // 1Ô∏è‚É£ If no token ‚Üí redirect immediately
  if (!token) {
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "../login.html";
    return;
  }

  try {
    // 2Ô∏è‚É£ Verify token with backend
    const res = await fetch("/.netlify/functions/getTeacherProfile", {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    // 3Ô∏è‚É£ If token invalid or expired ‚Üí logout
    if (res.status === 401) {
      localStorage.removeItem("auth_token");
      localStorage.removeItem("userId");
      localStorage.setItem("redirectAfterLogin", window.location.href);
      window.location.href = "../login.html";
      return;
    }

    // 4Ô∏è‚É£ If other error (404 profile not created yet) ‚Üí DO NOT logout
    if (!res.ok) {
      console.warn("Profile not found or other issue, but user still authenticated.");
      return;
    }

    const data = await res.json();

// Store profile
window.currentTeacherProfile = data.profile;

// Ensure userId is stored correctly
myId = data.profile.auth_user_id;
localStorage.setItem("userId", myId);

// Display profile
// displayMyProfile(data.profile);

// NOW fetch matches


console.log("Authenticated as:", data.profile.full_name);
  } catch (error) {
    console.error("Network error:", error);
    // Only redirect if completely broken
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "../login.html";
  }
})();

</script>
    <div id="debugUserId" class="p-2 bg-yellow-100 text-black mb-4"></div>

<script>
  const userId = localStorage.getItem("userId") || "not set";
  document.getElementById("debugUserId").textContent = "Logged-in user ID: " + userId;
  console.log("Logged-in user ID:", userId);
</script>


</body>
</html>
