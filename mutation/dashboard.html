<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Swap Matches</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold text-blue-700 mb-6">Swap Matches Dashboard</h1>
  <div id="matchesContainer" class="grid gap-4"></div>
</div>

<!-- Teacher Details Modal -->
<div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6 relative">
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
    <h2 id="modalName" class="text-xl font-semibold mb-2"></h2>
    <p id="modalSchool" class="mb-1"></p>
    <p id="modalLocation" class="mb-1"></p>
    <p id="modalPosition" class="mb-4"></p>
    <p id="modalContact" class="text-gray-600 text-sm"></p>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity duration-300"></div>

<script>
// ---------- Logged-in Teacher ----------
const myId = localStorage.getItem("teacherId") || "current_teacher_id"; // use real login ID

let matches = [];

// ---------- Render Matches ----------
function renderMatches() {
  const container = document.getElementById("matchesContainer");
  container.innerHTML = "";

  if (!matches.length) {
    container.innerHTML = "<p class='text-gray-600'>No matching teachers found.</p>";
    return;
  }

  matches.forEach(t => {
    const div = document.createElement("div");
    div.className = "bg-white p-4 rounded-lg shadow flex justify-between items-center";

    div.innerHTML = `
      <div>
        <p class="font-semibold text-lg">${t.full_name}</p>
        <p class="text-gray-700">${t.current_school} - ${t.current_sector}, ${t.current_district}, ${t.current_province}</p>
        <p class="text-gray-700">Qualification: ${t.position}</p>
        <p class="text-sm text-gray-500">Swap Status: <span class="font-medium">${t.swap_status}</span></p>
      </div>
      <div class="flex gap-2">
        <button onclick="viewTeacher('${t.user_id}')" class="text-blue-600 hover:underline">üëÅÔ∏è View</button>
        <button onclick="requestSwap('${t.user_id}')" 
          class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
          ${t.swap_status !== "none" ? "disabled class='bg-gray-400 cursor-not-allowed'" : ""}>
          Request Swap
        </button>
      </div>
    `;
    container.appendChild(div);
  });
}

// ---------- Fetch Matches ----------
async function fetchMatches() {
  try {
    const res = await fetch(`/.netlify/functions/get-matches?teacherId=${myId}`);
    const data = await res.json();
    matches = data.matches || [];
    renderMatches();
  } catch (err) {
    console.error(err);
    showToast("Failed to load matches", "error");
  }
}

// ---------- View Teacher Modal ----------
function viewTeacher(id) {
  const t = matches.find(m => m.user_id === id);
  if (!t) return;

  document.getElementById("modalName").textContent = t.full_name;
  document.getElementById("modalSchool").textContent = `School: ${t.current_school}`;
  document.getElementById("modalLocation").textContent = `Location: ${t.current_sector}, ${t.current_district}, ${t.current_province}`;
  document.getElementById("modalPosition").textContent = `Qualification: ${t.position}`;
  document.getElementById("modalContact").textContent = `Contact: ${t.contact}`;

  document.getElementById("teacherModal").classList.remove("hidden");
  document.getElementById("teacherModal").classList.add("flex");
}
function closeModal() {
  document.getElementById("teacherModal").classList.add("hidden");
  document.getElementById("teacherModal").classList.remove("flex");
}

// ---------- Request Swap ----------
async function requestSwap(requestedId) {
  try {
    const res = await fetch(`/.netlify/functions/request-swap`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ requester_id: myId, requested_id: requestedId })
    });
    const data = await res.json();

    if (!res.ok) throw new Error(data.message || "Failed to send swap request");

    const t = matches.find(m => m.user_id === requestedId);
    if (t) t.swap_status = "pending";
    renderMatches();
    showToast(`Swap request sent to ${t.full_name}`, "success");
  } catch (err) {
    console.error(err);
    showToast(err.message, "error");
  }
}

// ---------- Toast ----------
function showToast(message, type="info") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  const colors = {
    success: "bg-green-600",
    error: "bg-red-600",
    warning: "bg-yellow-500",
    info: "bg-gray-800"
  };
  toast.className = `fixed bottom-6 right-6 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg opacity-100 transition-opacity duration-300`;
  setTimeout(() => {
    toast.classList.add("opacity-0");
  }, 3000);
}

// ---------- Initialize ----------
fetchMatches();
</script>
<script>
(async function () {
  const token = localStorage.getItem("auth_token");

  // 1Ô∏è‚É£ If no token ‚Üí redirect immediately
  if (!token) {
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "login.html";
    return;
  }

  try {
    // 2Ô∏è‚É£ Verify token with backend
    const res = await fetch("/.netlify/functions/getTeacherProfile", {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    // 3Ô∏è‚É£ If token invalid or expired ‚Üí logout
    if (res.status === 401) {
      localStorage.removeItem("auth_token");
      localStorage.removeItem("userId");
      localStorage.setItem("redirectAfterLogin", window.location.href);
      window.location.href = "login.html";
      return;
    }

    // 4Ô∏è‚É£ If other error (404 profile not created yet) ‚Üí DO NOT logout
    if (!res.ok) {
      console.warn("Profile not found or other issue, but user still authenticated.");
      return;
    }

    const data = await res.json();

    // 5Ô∏è‚É£ Store profile globally
    window.currentTeacherProfile = data.profile;
    console.log("Authenticated as:", data.profile.full_name);

  } catch (error) {
    console.error("Network error:", error);
    // Only redirect if completely broken
    localStorage.setItem("redirectAfterLogin", window.location.href);
    window.location.href = "login.html";
  }
})();
</script>


</body>
</html>
