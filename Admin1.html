<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fila Assistant - Admin</title>
<link rel="stylesheet" href="css/style.css">
<style>
  body { font-family:sans-serif; background:#f4f6f8; padding:20px; }
  h1 { margin-bottom:10px; }
  input[type="text"] { padding:8px; width:300px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; }
  th { background:#2980b9; color:#fff; }
  .btn { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
  .btn-view { background:#27ae60; color:#fff; }
  .btn-delete { background:#e74c3c; color:#fff; }
  .toast { position: fixed; top:20px; right:20px; background:#4caf50; color:#fff; padding:10px 20px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); opacity:0; transition:0.3s; z-index:9999; }
  .toast.show { opacity:1; }
</style>
</head>
<body>

<h1>Admin Dashboard</h1>

<!-- Search -->
<input type="text" id="searchInput" placeholder="Search by name, email, or phone">

<table id="usersTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Balance</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5">Loading users...</td></tr>
  </tbody>
</table>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
const usersTableBody = document.querySelector("#usersTable tbody");
const searchInput = document.getElementById("searchInput");
const toast = document.getElementById("toast");

let usersData = []; // store users for search filtering

function showToast(message, success = true) {
  toast.textContent = message;
  toast.style.background = success ? "#4caf50" : "#e74c3c";
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// Fetch all users
async function fetchUsers() {
  try {
    const res = await fetch("/.netlify/functions/get-users");
    if (!res.ok) throw new Error("Failed to fetch users");
    usersData = await res.json();
    renderUsers(usersData);
  } catch(err) {
    usersTableBody.innerHTML = `<tr><td colspan="5">Error loading users.</td></tr>`;
    console.error(err);
    showToast("Error fetching users", false);
  }
}

// Render users to table

function renderUsers(users) {
  if (!users.length) {
    usersTableBody.innerHTML = `<tr><td colspan="6">No users found.</td></tr>`;
    return;
  }

  usersTableBody.innerHTML = "";

  users.forEach((user, index) => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${user.name}</td>
      <td>${user.email}</td>
      <td>${user.phone || "N/A"}</td>
      <td>${user.balance || 0}</td>
      <td>
        <button class="btn btn-view" onclick="viewPayments('${user.id}')">View Payments</button>
        <button class="btn btn-delete" onclick="deleteUser('${user.id}', this)">Delete</button>
      </td>
    `;

    usersTableBody.appendChild(row);
  });
                            }

// Search filter
searchInput.addEventListener("input", () => {
  const term = searchInput.value.toLowerCase();
  const filtered = usersData.filter(u =>
    (u.name && u.name.toLowerCase().includes(term)) ||
    (u.email && u.email.toLowerCase().includes(term)) ||
    (u.phone && u.phone.toLowerCase().includes(term))
  );
  renderUsers(filtered);
});

// Delete user
async function deleteUser(userId, btn) {
  if (!confirm("Are you sure you want to delete this user?")) return;
  try {
    const res = await fetch(`/.netlify/functions/delete-user?id=${userId}`, {
      method: "DELETE"
    });
    if (!res.ok) throw new Error("Failed to delete user");
    btn.closest("tr").remove();
    usersData = usersData.filter(u => u.id !== userId);
    showToast("User deleted successfully");
  } catch(err) {
    console.error(err);
    showToast(err.message, false);
  }
}

// View Payments (optional)
function viewPayments(userId) {
  window.location.href = `payments.html?user=${userId}`;
}

// Initial load
fetchUsers();
</script>

</body>
  </html>
