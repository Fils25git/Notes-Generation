<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buy Weekly Plans - Fila Assistant</title>
<meta property="og:type" content="website" />
<meta property="og:title" content="Fila Assistant" />
<meta property="og:description" content="Fila Assistant offers weekly lesson plans for teachers and students." />
<meta property="og:image" content="https://www.fleduacademy.com/logo.png" />
<meta property="og:url" content="https://www.fleduacademy.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    background: linear-gradient(135deg, #6dd5fa, #2980b9); 
    display: flex; justify-content: center; align-items: center; 
    min-height: 100vh; color: #333; position: relative; flex-direction: column;
  }
  .container { 
    background: #fff; padding: 30px 40px; border-radius: 16px; 
    box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align: center; 
    width: 100%; max-width: 450px; position: relative;
  }
  h2 { margin-bottom: 20px; }
  .packages button { 
    padding: 10px 15px; margin: 8px; border: none; border-radius: 12px; 
    background: linear-gradient(to right, #007bff, #00c6ff); 
    color: #fff; font-size: 16px; cursor: pointer; 
  }
  input[type="number"] { 
    width: 80%; padding: 10px; margin: 12px 0; border-radius: 8px; 
    border: 1px solid #ccc; font-size: 16px; 
  }
  button {
    padding: 10px 15px; border: none; border-radius: 12px; 
    background: #007bff; color: #fff; font-size: 14px; cursor: pointer; 
  }
  #ussd a { 
    display: inline-block; margin-top: 10px; padding: 10px 15px; 
    background: #28a745; color: #fff; border-radius: 12px; 
    text-decoration: none; font-weight: bold; 
  }
  #result { margin-top: 15px; font-weight: bold; }
  #confirmPayment { 
    display: inline-block; margin-top: 10px; padding: 10px 15px; 
    background: #28a745; color: #fff; border-radius: 12px; 
    text-decoration: none; font-weight: bold; 
  }
  #backBtn { 
    position: absolute; top: 10px; left: 20px; padding: 10px 15px; 
    border: none; border-radius: 12px; background: #007bff; color: #fff; 
    font-size: 14px; cursor: pointer; 
  }
  .floating-msg {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-50px); 
    padding: 15px 20px; border-radius: 12px; font-weight: bold; color: #fff; 
    min-width: 250px; text-align: center; z-index: 9999; opacity: 0; pointer-events: none; 
    transition: all 0.5s ease;
  }
  .floating-msg.show { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
  .floating-msg.success { background: #28a745; }
  .floating-msg.error { background: #dc3545; }
  .floating-msg .close { position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold; color: #fff; }
  footer { margin-top: 20px; text-align: center; font-size: 14px; color: #fff; width: 100%; }
  footer a { color: #fff; text-decoration: underline; margin: 0 5px; }
  @media (max-width: 480px){
    .container { padding: 20px 20px; }
    .packages button { width: 100%; margin: 5px 0; }
    input[type="number"] { width: 100%; }
  }
</style>
  <style>
.whatsapp-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #25D366;
    color: white;
    font-size: 28px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 1000;
    transition: 0.3s;
}

.whatsapp-btn:hover {
    transform: scale(1.1);
}
  </style>
</head>
<body>

<div class="container">
  <button id="backBtn"> ã€Šã€Š Back</button>
  
  <h2>Buy Weekly Plans</h2>

  <div>
    <p><b>BALANCE:</b> <span id="currentBalance">Loading...</span></p>
  </div>

  <div class="packages">
    <button data-amount="250">250 RWF â†’ 5 weekly plans</button>
    <button data-amount="500">500 RWF â†’ 15 weekly plans</button>
    <button data-amount="1000">1000 RWF â†’ 40 weekly plans</button>
  </div>

  <p>OR enter custom amount:</p>
  <input type="number" id="customAmount" placeholder="Enter amount in RWF" min="250">
  <button id="customPayBtn">Calculate & Generate USSD</button>

  <p id="result"></p>
  <p id="ussd"></p>
  <div>
    <button id="confirmPayment" disabled>I have paid</button>
  </div>

  <div id="floatingMsg" class="floating-msg">
    <span id="msgText"></span>
    <span class="close" onclick="closeMsg()">âœ–</span>
  </div>
  
<!-- WhatsApp Button -->
<a href="https://wa.me/250788123456" target="_blank" class="whatsapp-btn">
    <i class="fab fa-whatsapp"></i>
</a>
</div>

<footer>
  &copy; 2026 Fila Assistant | <a href="privacy.html">Privacy</a> | <a href="terms.html">Terms</a>
</footer>

<script>
// --- User setup ---
const userEmail = localStorage.getItem("user_email");
const userPhone = localStorage.getItem("user_phone");
if (!userEmail && !userPhone) window.location.href = "index.html";

// --- Floating messages ---
const floatingMsg = document.getElementById('floatingMsg');
const msgText = document.getElementById('msgText');
function showFloatingMessage(msg, type='success'){
    msgText.innerText = msg;
    floatingMsg.className = `floating-msg ${type} show`;
}
function closeMsg(){ floatingMsg.classList.remove('show'); }

// --- Elements ---
const packages = document.querySelectorAll('.packages button');
const customPayBtn = document.getElementById('customPayBtn');
const customAmountInput = document.getElementById('customAmount');
const resultEl = document.getElementById('result');
const ussdEl = document.getElementById('ussd');
const confirmPaymentBtn = document.getElementById('confirmPayment');
const backBtn = document.getElementById('backBtn');
const currentBalanceEl = document.getElementById('currentBalance');

const USSD_BASE = "*182*8*1*696720*"; 
let selectedAmount = null;
let pollInterval = null;
let pageLoadTime = Date.now();

// --- Weekly plan calculation ---
function calculateLessons(amount){
    if(amount >= 1000) return 40;
    if(amount >= 500) return 15;
    if(amount >= 250) return 5;
    return null;
}
function generateUSSD(amount){ return USSD_BASE + amount + "%23"; }

// --- Fetch balance ---
async function refreshBalance() {
    const identifier = userEmail || userPhone || "";
    try {
        let url = "/.netlify/functions/wp-get-balance";
        if (identifier.includes("@")) url += `?email=${encodeURIComponent(identifier)}`;
        else url += `?phone=${encodeURIComponent(identifier)}`;

        const res = await fetch(url);
        const data = await res.json();
        const weeklyBalance = data.weeklyBalance ?? 0;
        currentBalanceEl.innerText = `${weeklyBalance} weekly plan${weeklyBalance === 1 ? '' : 's'}`;
    } catch(err){
        console.error(err);
        currentBalanceEl.innerText = "Error loading";
    }
}

// --- Handle package buttons ---
packages.forEach(btn => {
    btn.addEventListener('click', () => {
        selectedAmount = parseInt(btn.dataset.amount);
        const lessons = calculateLessons(selectedAmount);
        if(!lessons){
            showFloatingMessage("Amount too low. Minimum is 250 RWF", 'error');
            resultEl.innerText = ""; ussdEl.innerHTML = ""; confirmPaymentBtn.disabled = true;
            return;
        }
        showFloatingMessage(`You will get ${lessons} weekly plans`);
        ussdEl.innerHTML = `<a href="tel:${generateUSSD(selectedAmount)}">Tap here to pay: ${generateUSSD(selectedAmount)}</a> <br>
        N.B:You pay with only <b>MTN MoMo Pay</b><br>Code:<b>696720</b><br>Account Name:<b>Fils Lambert</b><br>If you paid tap button belowðŸ‘‡`;
        confirmPaymentBtn.disabled = true;
        setTimeout(()=> confirmPaymentBtn.disabled = false, 30000);
    });
});

// --- Handle custom amount ---
customPayBtn.addEventListener('click', () => {
    selectedAmount = parseInt(customAmountInput.value);
    const lessons = calculateLessons(selectedAmount);
    if(!lessons){
        showFloatingMessage("Amount too low. Minimum is 250 RWF", 'error');
        resultEl.innerText = ""; ussdEl.innerHTML = ""; confirmPaymentBtn.disabled = true;
        return;
    }
    showFloatingMessage(`You will get ${lessons} weekly plans`);
    ussdEl.innerHTML = `<a href="tel:${generateUSSD(selectedAmount)}">Tap here to pay: ${generateUSSD(selectedAmount)}</a> <br>
        N.B:You pay with only <b>MTN MoMo Pay</b><br>Code:<b>696720<b><br>Account Name:<b>Fils Lambert</b><br>If you paid tap button belowðŸ‘‡`;
    confirmPaymentBtn.disabled = true;
    setTimeout(()=> confirmPaymentBtn.disabled = false, 10000);
});

// --- Confirm payment ---
confirmPaymentBtn.addEventListener('click', async () => {
    const now = Date.now();
    if(now - pageLoadTime < 30000){ 
        showFloatingMessage("Wait 10 seconds before confirming payment", 'error');
        return;
    }
    if(!selectedAmount){
        showFloatingMessage("Select a package or enter an amount first", 'error');
        return;
    }
    const phone = userPhone || "unknown";
    const email = userEmail || null;
    const reference = 'WP' + Date.now();
    try {
        const res = await fetch('/.netlify/functions/wp-record-payment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone,
                email,
                amount: selectedAmount,
                lessons: calculateLessons(selectedAmount),
                status: "pending",
                reference
            })
        });
        const text = await res.text();
        showFloatingMessage(text, 'success');
        confirmPaymentBtn.disabled = true;
        if(pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(refreshBalance, 10000);
    } catch(err){
        showFloatingMessage("Error: " + err.message, 'error');
    }
});

// --- Back button ---
backBtn.addEventListener('click', () => window.location.href = "index.html");

// --- Initial balance fetch ---
refreshBalance();
</script>
</body>
    </html>
