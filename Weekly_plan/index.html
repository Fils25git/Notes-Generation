<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila Assistant - CBC Weekly plan Generator</title>
    <meta property="og:type" content="website" />
<meta property="og:title" content="Fila Assistant" />
<meta property="og:description" content=" Fila Assistant is an educational website that offers a wide range of educational resources, including Lesson Plans, and study guides for teachers and students across primary and secondary education" />
<meta property="og:image" content="https://www.fleduacademy.com/../logo.png" />
<meta property="og:url" content="https://www.fleduacademy.com" />
    
    <link rel="stylesheet" href="plans.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        .profile-icon {
    font-size:28px; color:#4f46e5; cursor:pointer;
}
        Responsive footer */
  footer {
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
    color: #fff;
    width: 100%;
  }
  footer a {
    color: #fff;
    text-decoration: underline;
    margin: 0 5px;
      }
      
        body{
            background: linear-gradient(135deg, #6dd5fa, #2980b9);
        }
      .floating-message {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #e74c3c;
        color: #fff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;
        animation: slideIn 0.6s ease;
        max-width: 300px;
        line-height: 1.6;
      }
        #lessonPlanContent[contenteditable="true"] {
    border: 2px dashed #007bff;
    background: #f8fbff;
    padding: 15px;
        }

      @keyframes slideIn {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .floating-message a {
        color: #fff;
        text-decoration: underline;
        font-weight: bold;
      }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
  <div class="header">
    <div class="header-left">
        <img src="../logo.png">
        <h2>Fila Assistant</h2>
    </div>

    <!-- Profile Icon (fixed right) -->
    <i id="profileIcon"
       class="fas fa-user-circle profile-icon"
       onclick="go('../profile.html')"
       title="My Profile">
    </i>
</div>
   
    <!-- Form -->
    <div class="form-container">
        <p><b>Fill in the required fields below To Fetch Lesson Plan</b></p><br>
        
<form id="weeklyPlanForm">

<h3>ğŸ“Œ General Information</h3>

<label>Date</label>
<input type="date" id="date" required>

<label>Term</label>
<select id="term" required>
  <option value="">Select term</option>
  <option value="I">Term I</option>
  <option value="II">Term II</option>
  <option value="III">Term III</option>
</select>

<label>Level</label>
<input type="text" id="level" placeholder="e.g. Nursery, P1" required>

<label>Academic Year</label>
<input type="text" id="year" placeholder="e.g. 2025" required>

<label>Number of Children</label>
<input type="number" id="childrensNumber" required>

<label>Main Topic</label>
<input type="text" id="mainTopic" required>

<label>Sub Topic (Kinyarwanda)</label>
<input type="text" id="subTopic" required>

<label>Sub Topic (English)</label>
<input type="text" id="subTopicEng" required>

<label>Special Educational Needs</label>
<input type="text" id="specialNeeds" placeholder="Optional">

<hr>

<h3>ğŸ•¢ 7:45 â€“ 8:00 | Guhana ikaze</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_0745" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0745" required>

<h3>ğŸ•— 8:00 â€“ 8:30 | Imibare</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_0800" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0800" required>

<h3>ğŸ•£ 8:30 â€“ 9:00 | Ubumenyi bw'Ibidukikije</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_0830" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0830" required>

<h3>ğŸ•˜ 9:00 â€“ 9:30 | Ikinyarwanda</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_0900" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0900" required>

<h3>ğŸ•¤ 9:30 â€“ 10:00 | English Oral Communication</h3>
<label>Lesson Focus</label>
<input type="text" id="ikigwa_0930" required>
<label>Related Content</label>
<input type="text" id="ibindi_byigwa_0930" required>

<h3>ğŸ•¥ 10:40 â€“ 11:00 | Outdoor Games</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_1040" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1040" required>

<h3>ğŸ•š 11:00 â€“ 11:20 | Arts and Culture</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_1100" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1100" required>

<h3>ğŸ•¦ 11:20 â€“ 11:40 | Indoor Games</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_1120" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1120" required>

<h3>ğŸ•› 11:40 â€“ 12:00 | Closing Time</h3>
<label>Ikigwa</label>
<input type="text" id="ikigwa_1140" required>
<label>Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1140" required>

<hr>

<button type="submit">Generate Weekly Plan</button>

</form>
    </div>

    <!-- Result -->
    <div id="resultContainer" class="result-container">
        <div class="download-buttons">
            <button class="download-btn btn-word" onclick="copyToWord()">ğŸ“„ Copy to Word</button>
            <button class="download-btn btn-pdf" onclick="window.print()">ğŸ“‘ Save as PDF/Print</button>
    <button id="editBtn" Class="download-btn">âœï¸ Edit</button>
    <button id="saveBtn" class="download-btn" disabled>ğŸ’¾ Save</button>
            
        </div>
        <div id="lessonPlanContent" class="lesson-plan"></div>
        
    </div>
</div>

<div id="floatingMessage" class="floating-message"></div>


<!-- Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script>
    // ===============================
    // AUTH CHECK
    // ===============================
    const token = localStorage.getItem("auth_token");
    const userEmail = localStorage.getItem("user_email");

    if (!token || !userEmail) {
        window.location.href = "../login.html";
    }

    // ===============================
    // FLOATING MESSAGE
    // ===============================
    function showFloatingMessage(msg) {
        const box = document.getElementById("floatingMessage");
        box.innerHTML = msg;
        box.style.display = "block";
        setTimeout(() => box.style.display = "none", 8000);
    }

    // ===============================
    // PLAN FILES
    // ===============================
    const planFolders = {
        english: "proposals",
        kinyarwanda: "kinyarwanda_plans",
        kiswahili: "kiswahili_plans",
        french: "french_plans"
    };

    function getNextPlanFile(language, email) {
    const folder = planFolders[language] || "proposals";

    // English has 15 plans, others have 10
    const totalPlans = language === "english" ? 15 : 10;

    const storageKey = `last_plan_${language}_${email}`;
    let lastIndex = parseInt(localStorage.getItem(storageKey)) || 0;

    let nextIndex = lastIndex + 1;

    if (nextIndex > totalPlans) {
        nextIndex = 1; // restart after finishing all plans
    }

    localStorage.setItem(storageKey, nextIndex);

    return `${folder}/plan${nextIndex}.html`;
    }

    // ===============================
    // DEFAULTS
    // ===============================
    function getLanguageDefaults(language, subject, classLevel) {
        return {
            specialNeeds: {
                english: "There is no learner with special educational needs.",
                kinyarwanda: "Nta munyeshuri ufite ibyo agenerwa by'ihariye.",
                kiswahili: "Hakuna mwanafunzi mwenye mahitaji maalum.",
                french: "Il n'y a aucun Ã©lÃ¨ve ayant des besoins spÃ©ciaux."
            },
            teachingMaterials: {
                english: `${subject} textbook, learner's book, teacher's guide.`,
                kinyarwanda: `${subject} igitabo cy'umunyeshuri ${classLevel}.`,
                kiswahili: `Kitabu cha ${subject} cha darasa la ${classLevel}.`,
                french: `Livre de ${subject} pour ${classLevel}.`
            },
            references: {
                english: `${subject} learnerâ€™s book, REB curriculum.`,
                kinyarwanda: `${subject} igitabo cy'umunyeshuri.`,
                kiswahili: `Kitabu cha mwanafunzi cha ${subject}.`,
                french: `Livre de l'Ã©lÃ¨ve ${subject}.`
            }
        };
    }

    // ===============================
    // FORM SUBMIT
    // ===============================
    document.getElementById("lessonForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const btn = document.querySelector(".generate-btn");
        btn.disabled = true;
        btn.textContent = "Fetching...";

        try {
            const res = await fetch(`/.netlify/functions/get-balance?email=${userEmail}`);
            const data = await res.json();

            if (data.balance <= 0) {
                showFloatingMessage("âŒ No lesson plans remaining.");
                btn.disabled = false;
                btn.textContent = "Fetch Lesson Plan";
                return;
            }

            await fetch("/.netlify/functions/use-lesson-plan", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail })
            });

            generateLessonPlan();

        } catch (err) {
            showFloatingMessage("âŒ Network error.");
            btn.disabled = false;
            btn.textContent = "Fetch Lesson Plan";
        }
    });

    // ===============================
    // GENERATE + AUTO SAVE
    // ===============================
    function generateLessonPlan() {
        const language = document.getElementById("language").value || "english";
        const subjectVal = subject.value;
        const classVal = document.getElementById("class").value;
        const defaults = getLanguageDefaults(language, subjectVal, classVal);

        const data = {
            schoolName: schoolName.value,
            teacherName: teacherName.value,
            term: term.value,
            date: date.value,
            subject: subjectVal,
            class: classVal,
            unitNo: unitNo.value,
            lessonNo: lessonNo.value,
            totalLessons: totalLessons.value,
            duration: duration.value,
            classSize: classSize.value,
            unitTitle: unitTitle.value,
            lessonTitle: lessonTitle.value,
            teachingMaterials: teachingMaterials.value || defaults.teachingMaterials[language],
            specialNeeds: specialNeeds.value || defaults.specialNeeds[language],
            references: references.value || defaults.references[language]
        };

        fetch(getNextPlanFile(language, userEmail))
            .then(res => res.text())
            .then(template => {

                for (const key in data) {
    template = template
        .replace(new RegExp(`{{\\s*${key}\\s*}}`, "g"), data[key])
        .replace(new RegExp(`\\$\\{\\s*${key}\\s*\\}`, "g"), data[key]);
    }

                lessonPlanContent.innerHTML = template;
                resultContainer.classList.add("show");
                resultContainer.scrollIntoView({ behavior: "smooth" });

                // ğŸ”¥ AUTO SAVE TO DATABASE USING EMAIL ONLY
                autoSavePlan(template, language, data.lessonTitle);

            })
            .catch(() => {
                showFloatingMessage("âŒ Failed to load lesson plan.");
            });
    }

    // ===============================
    // AUTO SAVE FUNCTION (DATABASE)
    // ===============================
    async function autoSavePlan(content, language, title) {
        try {
            const res = await fetch("/.netlify/functions/create-user-plan", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: userEmail,   // <-- use email instead of user_id
                    lesson_title: title,
                    lesson_content: content,
                    language
                })
            });

            const data = await res.json();

            if (!res.ok) {
                console.error("SAVE FAILED:", data);
                showFloatingMessage("âš ï¸ Lesson generated but not saved.");
            }

        } catch (err) {
            console.error("AUTO SAVE ERROR:", err);
        }
    }

    // ===============================
    // EDIT & COPY (UNCHANGED)
    // ===============================
    editBtn.addEventListener("click", () => {
        lessonPlanContent.contentEditable = true;
        editBtn.disabled = true;
        saveBtn.disabled = false;
    });

    saveBtn.addEventListener("click", () => {
        lessonPlanContent.contentEditable = false;
        editBtn.disabled = false;
        saveBtn.disabled = true;
    });

    function copyToWord() {
        const range = document.createRange();
        range.selectNode(lessonPlanContent);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        showFloatingMessage("Lesson Plan copied.");
    }
    function go(path) {
    window.location.href = path;
}
</script>

</body>
    </html>
