<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila Assistant - CBC Weekly plan Generator</title>
    <meta property="og:type" content="website" />
<meta property="og:title" content="Fila Assistant" />
<meta property="og:description" content=" Fila Assistant is an educational website that offers a wide range of educational resources, including Lesson Plans, and study guides for teachers and students across primary and secondary education" />
<meta property="og:image" content="https://www.fleduacademy.com/../logo.png" />
<meta property="og:url" content="https://www.fleduacademy.com" />
    
    <link rel="stylesheet" href="plans.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        .profile-icon {
    font-size:28px; color:#4f46e5; cursor:pointer;
}
/*Responsive footer */
  footer {
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
    color: #fff;
    width: 100%;
  }
  footer a {
    color: #fff;
    text-decoration: underline;
    margin: 0 5px;
      }
      
        body{
            background: linear-gradient(135deg, #6dd5fa, #2980b9);
        }
      .floating-message {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #e74c3c;
        color: #fff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;
        animation: slideIn 0.6s ease;
        max-width: 300px;
        line-height: 1.6;
      }
        #lessonPlanContent[contenteditable="true"] {
    border: 2px dashed #007bff;
    background: #f8fbff;
    padding: 15px;
        }

    

      .floating-message a {
        color: #fff;
        text-decoration: underline;
        font-weight: bold;
      }
        
      
        body{
            background: linear-gradient(135deg, #6dd5fa, #2980b9);
        }
      .floating-message {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #e74c3c;
        color: #fff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;
        animation: slideIn 0.6s ease;
        max-width: 300px;
        line-height: 1.6;
      }
        #lessonPlanContent[contenteditable="true"] {
    border: 2px dashed #007bff;
    background: #f8fbff;
    padding: 15px;
        }

      @keyframes slideIn {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .floating-message a {
        color: #fff;
        text-decoration: underline;
        font-weight: bold;
              }
        #resultContainer {
  display: none;
                                    }
        #resultContainer.show {
    display: block;
    animation: fadeIn 0.4s ease-in-out;
            }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
  <div class="header">
    <div class="header-left">
        <img src="../logo.png">
        <h2>Fila Assistant</h2>
    </div>

    <!-- Profile Icon (fixed right) -->
    <i id="profileIcon"
       class="fas fa-user-circle profile-icon"
       onclick="go('../profile.html')"
       title="My Profile">
    </i>
</div>
   
    <!-- Form -->
    <div class="form-container">
        <p><b>Fill in the required fields below To Fetch Weekly Plan</b></p><br>
        
<form id="lessonForm">
<div class="form-grid">

<h3>ðŸ“Œ General Information</h3>

    <div class="form-group">
                    <label class="required">School Name</label>
                    <input type="text" id="schoolName" placeholder="e.g:,EP KABIRIZI"  required>
    </div>

    <div class="form-group">
                    <label class="required">Teacher's Name</label>
                    <input type="text" id="teacherName" placeholder="e.g:, IRATURINZE Fils Lambert" required>
    </div>
    
                <div class="form-group">
<label class="required">From Date/ To Date</label>
                    <div class="double-input">
<input type="date" id="date" required>
<input type="date" id="toDate"  required>
                </div>
                </div>
    
                <div class="form-group">
<label class="required">Term</label>
<select id="term" required>
  <option value="">Select term</option>
  <option value="I">Term I</option>
  <option value="II">Term II</option>
  <option value="III">Term III</option>
</select>
                </div>
    
                <div class="form-group">
<label class="required" class="required">Ikiciro/Level</label>
<input type="text" id="level" placeholder="e.g. N1, N3A" required>
                </div>
    
                <div class="form-group">
<label class="required">Umwaka w'amashuri/Academic Year</label>
<input type="text" id="year" placeholder="e.g. 2025-2026" required>
                </div>
    
                <div class="form-group">
<label class="required">Umubare w'abanyeshuri/Number of learners</label>
<input type="number" id="childrensNumber" placeholder=" e.g, 30" required>
                </div>
                                <div class="form-group">
<label class="required">Icyumweru cya/Week</label>
<input type="number" id="week" placeholder=" e.g, 5" required>
                </div>
    
                <div class="form-group">

<label class="required">Insanganyamatsiko nini (Kinyarwanda)</label>
<input type="text" id="mainTopic" placeholder="Andika insanganyamatsiko nini mu Kinyarwanda" required>
                </div>
    
                <div class="form-group">

    <label class="required">Insanganyamatsiko nini (in English)</label>
                
<input type="text" id="mainTopicEng" placeholder="Write theme in English" required>
                    </div>
    
                <div class="form-group">
<label class="required">Insanganyamatsiko nto ( mu Kinyarwanda)</label>
                
<input type="text" id="subTopic" placeholder="Andika insanganyamatsiko nto mu Kinyarwanda" required>
                </div>

                <div class="form-group">
<label class="required">Insanganyamatsiko nto ( in English)</label>
<input type="text" id="subTopicEng" placeholder="Write sub Theme in English" required>
                </div>

                <div class="form-group full-width">
<label class="optional">Abafite Ibibazo byihariye (Niba bahari)/Special Educational Needs (If available)</label>
<input type="text" id="specialNeeds" placeholder="e.g, Abana 2 bafite ubumuga bwo kutabona">
                </div>

<hr>

<h3>ðŸ•¢ 7:45 â€“ 8:00 | Guhana ikaze/Welcoming Time</h3>
    
    <div class="form-group">
<label class="required">Ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_0745" placeholder="e.g, Gukora uruziga" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0745" placeholder="e.g,Igororamubiri,Imibare" required>
        </div>
    </div><br>

<h3>ðŸ•— 8:00 â€“ 8:30 |  Ubumenyi bw'Ibidukikije/Discovery of the world</h3>
    <div class="form-group">
<label class="required">Ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_0800" placeholder="e.g, kuririmba" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0800" placeholder="e.g, ikinyarwanda" required>
<label class="required">Amasomo Azibandwaho</label>
<input type="text" id="isomo_time_0800" placeholder="e.g,Isuku ku mubiri" required>

        </div>
        </div>
    <br>

<h3>ðŸ•£ 8:30 â€“ 9:00 | Imibare/Numeracy</h3>
    <div class="form-group">
<label class="required">Ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_0830" placeholder="e.g, Kubaka udutafari" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0830" placeholder="indimi,..." required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_0830" placeholder="e.g,Kubara kuva kuri 1 kugera ku 10" required>

        </div>
        </div>
    <br>

<h3>ðŸ•˜ 9:00 â€“ 9:30 | Ikinyarwanda</h3>
    <div class="form-group">
<label class="required">ubwoko bw'igikorwa</label>
      <div class="form-group">  
<input type="text" id="activity_time_0900" placeholder="e.g, Gushushanya inyajwi" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_0900" placeholder="e.g, imibare, ubumenyi bw'ibidukikije,..." required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_0900" placeholder="e.g,Kwandika inyajwi 'a' " required>

        </div>
        </div>
    <br>
<h3>ðŸ•¤ 9:30 â€“ 10:00 | English Oral Communication</h3>
    <div class="form-group">
<label class="required">ubwoko bw'igikorwa(in English)</label>
        <div class="form-group">
<input type="text" id="activity_time_0930" placeholder="e.g, Playig games related to greeting" required>
<label class="required">Ibindi byigwa(in English)</label>
<input type="text" id="ibindi_byigwa_0930" placeholder="e.g, Numracy, Story teling " required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_0930" placeholder="e.g, greeting people at school" required>

        </div>
        </div>
    <br>
<h3>ðŸ•¥ 10:40 â€“ 11:00 | Imikino yo hanze(Ibonezabuzima)/Physical Development</h3>
    <div class="form-group">
<label class="required">Ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_1040" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1040" required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_1040" placeholder="e.g,guteranya (bifashishije ibikoesho byo hanze)" required>

        </div>
        </div>
    <br>

<h3>ðŸ•š 11:00 â€“ 11:20 | Ubugeni n'umuco/Arts and Culture(Kuwa 1 no kuwa 3)</h3>
    <div class="form-group">
<label class="required">ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_1100" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1100" required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_1100" placeholder="e.g, Gushushanya isura y'umuntu" required>

        </div>
        </div>
    <br>

<h3>ðŸ•¦ 11:00 â€“ 11:20 | Kubara Inkuru mu Kinyarwanda/Story Time Kinyarwanda(kuwa 2,4,5)</h3>
    <div class="form-group">
<label class="required">Ubwoko bw'igikorwa</label>
        <div class="form-group">
<input type="text" id="activity_time_1120" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1120" required>

        </div>
        </div>
    <br>

<h3>ðŸ•› 11:20 â€“ 11:40 | Imikino yo mu nguni/Free corner play</h3>
    <div class="form-group">
<label class="required">ubwoko bw'igikorwa</label>
    <div class="form-group">
<input type="text" id="activity_time_1130" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1130" required>
<label class="required">Amasomo azibandwaho</label>
<input type="text" id="isomo_time_1130" placeholder="e.g, Gukina umukino wo gutahura inyuguti" required>

        </div>
    </div><br>
    <h3>ðŸ•› 11:40 â€“ 12:00 | Gusezeranaho/Closing Time</h3>
    <div class="form-group">
<label class="required">ubwoko bw'igikorwa</label>
    <div class="form-group">
<input type="text" id="activity_time_1140" required>
<label class="required">Ibindi byigwa</label>
<input type="text" id="ibindi_byigwa_1140" required>
    </div>
    </div><br>
     <h3>ITERAMBERE MU MBAMUTIMA N'IMIBANIRE N'ABANDI</h3>
    <div class="form-group">
    <label class="required" for="isomo_iterambere">Amasomo Azibandwaho</label>
    <div class="form-group">
<textarea id="isomo_iterambere"
          placeholder="e.g, Kwerekana imbamutima ku mashushusho"
          required></textarea>
          </div>

<hr>

<button type="submit" class="generate-btn">Generate Weekly Plan</button>
    <div id="errorMessage" class="error-message"></div>

</form>
    </div>
</div>
    <!-- Result -->
    <div id="resultContainer" class="result-container">
        <div id="actionButtons" class="download-buttons">
            <button class="download-btn" id="editBtn" style="display:none;">Edit</button>
<button class="download-btn" id="saveBtn" style="display:none;">Save</button>
<button id="downloadBtn" class="download-btn btn-pdf" onclick="downloadPDFProper()" style="display:none;">ðŸ“‘ Download PDF</button>
            <button class="download-btn btn-pdf" onclick="window.print()">ðŸ“‘ Save as PDF/Print</button>
            
            
        </div>
        

        <div id="lessonPlanContent" class="lesson-plan">
			<div id="themeWebOutput"  margin-bottom:20px;">
    <h3 style="text-align:center">IMBATA  NKOMATANYO Y'ICYUMWERU</h3>

   <div id="diagram" class="diagram-wrapper">
        
<svg class="lines" viewBox="0 0 100 120" preserveAspectRatio="none">

    <!-- TOP (INDIMI) -->
    <line x1="48" y1="70" x2="48" y2="25" />

    <!-- LEFT (IMIBARE) -->
    <line x1="22" y1="60" x2="5" y2="35" />

    <!-- RIGHT (IBONEZABUZIMA) -->
    <line x1="67" y1="55" x2="80" y2="45" />

    <!-- BOTTOM (UBUMENYI BW'IBIDUKIKIJE) -->
    <line x1="48" y1="70" x2="48" y2="90" />
    <!-- BOTTOM-LEFT (UBUGENI N'UMUCO) -->
    <line x1="22" y1="70" x2="10" y2="88" />

    <!-- BOTTOM-RIGHT (ITERAMBERE) -->
    <line x1="60" y1="70" x2="80" y2="85" />

</svg>

        <!-- BOXES -->
        <div class="box top"><b>INDIMI</b>
			<div id="out_indimi">
                <p>
                    <ul>
                        <li>Ikinyarwanda:{{isomo_time_0900}}</li><br>
                        <li>English:{{isomo_time_0930}}</li>
                    </ul>
                </p>
            </div>
		</div>
        <div class="box left"> <b>IMIBARE</b>
			<div id="out_mibare"><p>{{isomo_time_0830}}</p>
			</div>
		</div>
        <div class="box right"><b>IBONEZABUZIMA<br></b><div id="out_ibonezabuzima"><br>
			{{isomo_time_1040}}
		</div></div>
        <div class="box bottom"><b>UBUMENYI BW'IBIDUKIKIJE</b><br>
          <div id="out_ubuvumbyi">
              <p>
                   {{isomo_time_0800}}
              </p>
          </div></div>
        <div class="box bottom-left"><b>UBUGENI N' UMUCO</b>
              <div id="out_ubushobozi"><br>
                {{isomo_time_1100}}
              </div></div>
        <div class="box bottom-right"><b>ITERAMBERE MU MBAMUTIMA N'IMIBANIRE N'ABANDI</b>
			<div id="out_iterambere"><br>
				{{isomo_iterambere}}
			</div>
		</div>

        <div class="box center">
            <b>Insanganyamatsiko nini:</b>{{mainTopic}}<br>
            <b>Insanganyamatsiko nto</b>:{{subTopic}}
            <div id="out_theme"><b>Umwaka wa:</b>{{level}}<br>
            <b>Igihembwe cya:</b>{{term}}<br>
            <b>Icyumweru cya:</b>{{week}}</div>
        </div>

    </div>
			</div>
		</div>
        
    </div>
</div>


<div id="floatingMessage" class="floating-message"></div>


<!-- Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
let currentPlanIndex = 1; // plan1.html start
const totalPlans = 5;     // total templates

// DOM elements
const lessonForm = document.getElementById("lessonForm");
const lessonPlanContent = document.getElementById("lessonPlanContent");
const resultContainer = document.getElementById("resultContainer");
const floatingMessage = document.getElementById("floatingMessage");
const btn = document.querySelector(".generate-btn");
const editBtn = document.getElementById("editBtn");
const saveBtn = document.getElementById("saveBtn");

// Auth check
const token = localStorage.getItem("auth_token");
const userEmail = localStorage.getItem("user_email");
if (!token || !userEmail) window.location.href = "../login.html";

// ===============================
// FLOATING MESSAGE
// ===============================
function showFloatingMessage(msg) {
  floatingMessage.innerHTML = msg;
  floatingMessage.style.display = "block";
  setTimeout(() => (floatingMessage.style.display = "none"), 6000);
}

// ===============================
// AUTO SAVE FUNCTION
// ===============================
async function autoSaveWeeklyPlan(content) {
  try {
    await fetch("/.netlify/functions/create-user-plan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: userEmail,
        lesson_title: "CBC Weekly Schedule",
        lesson_content: content,
        language: "kinyarwanda",
      }),
    });
  } catch (err) {
    console.error("Auto-save failed", err);
  }
}

// ===============================
// FORM SUBMIT
// ===============================
lessonForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  btn.disabled = true;
  btn.textContent = "Generating...";

  try {
    // 1ï¸âƒ£ Deduct 1 weekly plan
    const useRes = await fetch("/.netlify/functions/use-weekly-lesson-plan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: userEmail }),
    });

    const data = await useRes.json();

    if (!data.success) {
      showFloatingMessage(`âŒ ${data.message}`);
      btn.disabled = false;
      btn.textContent = "Generate Weekly Plan";
      return;
    }

    // 2ï¸âƒ£ Load current template (plan1 â†’ plan5)
    const templatePath = `proposal/plan${currentPlanIndex}.html`;
    const templateRes = await fetch(templatePath);
    if (!templateRes.ok) throw new Error("Template not found");
    let templateText = await templateRes.text();

    // 3ï¸âƒ£ Prepare form data
    const formData = {};
    lessonForm.querySelectorAll("input, select, textarea").forEach((el) => {
      formData[el.id] = el.value || "";
    });

    // 4ï¸âƒ£ Replace placeholders
    for (const key in formData) {
      templateText = templateText.replace(
        new RegExp(`{{\\s*${key}\\s*}}`, "g"),
        formData[key]
		  
      );
    }
let diagramHTML = document.getElementById("themeWebOutput").outerHTML;

for (const key in formData) {
  const regex = new RegExp(`{{\\s*${key}\\s*}}`, "g");
  diagramHTML = diagramHTML.replace(regex, formData[key]);
		}
    // 5ï¸âƒ£ Display plan
    lessonPlanContent.innerHTML = diagramHTML + templateText;
    resultContainer.classList.add("show");
      document.getElementById("resultContainer").style.display = "block";
      document.getElementById("downloadBtn").style.display = "inline-block";
document.getElementById("editBtn").style.display = "inline-block";
document.getElementById("saveBtn").style.display = "inline-block";
    resultContainer.scrollIntoView({ behavior: "smooth" });

    // 6ï¸âƒ£ Auto-save
    await autoSaveWeeklyPlan(templateText);

    // 7ï¸âƒ£ Rotate plan index
    currentPlanIndex++;
    if (currentPlanIndex > totalPlans) currentPlanIndex = 1;

  } catch (err) {
    console.error(err);
    showFloatingMessage("âŒ Network or template error.");
    btn.disabled = false;
    btn.textContent = "Generate Weekly Plan";
  }
});

// ===============================
// EDIT & SAVE
// ===============================
editBtn.addEventListener("click", () => {
  lessonPlanContent.contentEditable = true;
  editBtn.disabled = true;
  saveBtn.disabled = false;
});

saveBtn.addEventListener("click", () => {
  lessonPlanContent.contentEditable = false;
  editBtn.disabled = false;
  saveBtn.disabled = true;
});
        function resetGenerator(){
  const btn = document.getElementById("generateBtn");
  btn.disabled = false;
  btn.textContent = "Generate Weekly Plan";

  document.getElementById("downloadBtn").style.display = "none";
  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "none";
        }

// ===============================
// COPY TO WORD
// ===============================
function copyToWord() {
  const range = document.createRange();
  range.selectNode(lessonPlanContent);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);
  document.execCommand("copy");
  window.getSelection().removeAllRanges();
  showFloatingMessage("âœ… Weekly plan copied.");
}

// ===============================
// DOWNLOAD PDF
// ===============================
    async function downloadPDFProper() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "mm", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();

  // TITLE
  doc.setFontSize(14);
const titleY = 12; // title Y position
doc.text("IMBATA NKOMATANYO Y'ICYUMWERU", pageWidth / 2, titleY, { align: "center" });

// Start diagram immediately after title
let y = titleY; // no extra space

// ðŸ”¥ CAPTURE DIAGRAM AS IMAGE
const diagram = document.getElementById("diagram");
if (diagram) {
    // Make a larger canvas for better resolution
    const canvas = await html2canvas(diagram, { scale: 3, useCORS: true });
    const imgData = canvas.toDataURL("image/png");

    const pageWidth  = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin     = 10;
    const maxWidth   = pageWidth - margin * 2;
    const maxHeight  = pageHeight - 30; // leave space for title

    const ratio = canvas.width / canvas.height;

    let imgWidth  = maxWidth;
    let imgHeight = imgWidth / ratio;

    // If height is too big, scale by height
    if (imgHeight > maxHeight) {
        imgHeight = maxHeight;
        imgWidth  = imgHeight * ratio;
    }

    // Center horizontally
    const x = (pageWidth - imgWidth) / 2;

    doc.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
    y += imgHeight + 8;
}


  // SCHOOL & TEACHER INFO
  doc.setFontSize(10);
  doc.text(`AMAZINA Y'UMUREZI: ${teacherName.value}`, 14, y);
  doc.text(`IZINA RY'ISHURI: ${schoolName.value}`, pageWidth - 14, y, { align: "right" });
  y += 8;

  // EXTRACT TABLES
  const tables = document.querySelectorAll("#lessonPlanContent table");
  if (!tables.length) {
    alert("No tables found in lesson plan.");
    return;
  }

  function flattenCellContent(td) {
    let html = td.innerHTML.trim();
    html = html.replace(/<li>/gi, "â€¢ ").replace(/<\/li>/gi, "\n");
    html = html.replace(/<br\s*\/?>/gi, "\n");
    html = html.replace(/<[^>]*>/g, "");
    return html;
  }

  function extractTableFlattened(table) {
    const head = [], body = [], rowSpans = [];
    table.querySelectorAll("thead tr").forEach(tr => {
      const row = [];
      tr.querySelectorAll("th").forEach(th => row.push(th.innerText.trim()));
      head.push(row);
    });
    table.querySelectorAll("tbody tr").forEach(tr => {
      const row = [];
      let colIndex = 0;
      tr.querySelectorAll("td").forEach(td => {
        while (rowSpans[colIndex] && rowSpans[colIndex].rowsLeft > 0) {
          row.push(rowSpans[colIndex].value);
          rowSpans[colIndex].rowsLeft--;
          colIndex++;
        }
        const value = flattenCellContent(td);
        const colspan = parseInt(td.getAttribute("colspan") || "1", 10);
        const rowspan = parseInt(td.getAttribute("rowspan") || "1", 10);
        for (let c = 0; c < colspan; c++) row.push(value);
        if (rowspan > 1) for (let c = 0; c < colspan; c++) rowSpans[colIndex + c] = { value, rowsLeft: rowspan - 1 };
        colIndex += colspan;
      });
      while (rowSpans[colIndex] && rowSpans[colIndex].rowsLeft > 0) {
        row.push(rowSpans[colIndex].value);
        rowSpans[colIndex].rowsLeft--;
        colIndex++;
      }
      body.push(row);
    });
    return { head, body };
  }

  // FIRST TABLE
  let currentY = y; // start after diagram

// First table
const first = extractTableFlattened(tables[0]);
doc.autoTable({
  head: first.head,
  body: first.body,
  startY: currentY,
  theme: "grid",
  styles: { fontSize: 10, cellPadding: 3, overflow: "linebreak" },
  headStyles: { fillColor: [245, 245, 245], textColor: 0, fontStyle: "bold" },
  margin: { left: 8, right: 8 },
  rowPageBreak: "avoid",
});

// Update currentY to the bottom of the last table
currentY = doc.lastAutoTable.finalY + 5; // add small gap

// Second table
const second = extractTableFlattened(tables[1]);
doc.autoTable({
  head: second.head,
  body: second.body,
  startY: currentY,
  theme: "grid",
  styles: { fontSize: 10, cellPadding: 3, overflow: "linebreak" },
  headStyles: { fillColor: [245, 245, 245], textColor: 0, fontStyle: "bold" },
  margin: { left: 8, right: 8 },
  rowPageBreak: "avoid",
});
		}

  // SAVE
  // Get todayâ€™s date
const today = new Date().toISOString().split("T")[0];

// Make the filename safe (replace spaces and special characters in subTopicEng)
const safeSubTopic = subTopicEng.value.replace(/[^a-z0-9]/gi, '_');

// Save PDF with desired format
doc.save(`${safeSubTopic}_weekly_plan_${today}.pdf`);
}
		function fitText(box) {
    let minFont = 8;   // smallest allowed
    let maxFont = 14;  // starting size
    let fontSize = maxFont;

    /*box.style.fontSize = fontSize + "px";*/

    while (box.scrollHeight > box.clientHeight && fontSize > minFont) {
        fontSize--;
        box.style.fontSize = fontSize + "px";
    }
}

function fitAllBoxes() {
    document.querySelectorAll(".box").forEach(box => fitText(box));
}

// Run after content loads
window.addEventListener("load", fitAllBoxes);
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</body>
  </html>
