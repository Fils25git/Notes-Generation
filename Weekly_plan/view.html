<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Lesson Plan</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- html2pdf for full-page PDF download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f6f8;
}

header {
    padding: 10px 20px;
    background: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

header h1 { font-size: 1.5rem; margin:0; }
header button {
    background: #9e9e9e;
    color: #fff;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
}

.container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.buttons button {
    padding: 8px 12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:5px;
    font-size:.9rem;
}

.btn-copy { background:#ff9800; color:#fff; }
.btn-pdf { background:#4caf50; color:#fff; }

#lessonContent {
    min-height: 300px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding:15px;
    background:#fafafa;
    overflow-x:auto;
    overflow-y:auto;
}

/* Table styling */
#lessonContent table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    table-layout: fixed; /* responsive columns */
    word-wrap: break-word;
}

#lessonContent th, #lessonContent td {
    border: 1px solid #333;
    padding: 8px;
    text-align: left;
    vertical-align: top;
}

#lessonContent th {
    background: #4caf50;
    color: #fff;
}

#lessonContent tr:nth-child(even) {
    background: #f2f2f2;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: #fff;
    padding: 10px 18px;
    border-radius:6px;
    opacity:0;
    transition:.3s;
    z-index:999;
}

.toast.show { opacity:1; }

@media(max-width:600px){
    header h1 { font-size:1.2rem; }
    .buttons { flex-direction: column; }
}
</style>
</head>

<body>

<header>
    <h1>View Lesson Plan</h1>
    <button onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
</header>

<div class="container">
    <div class="buttons">
        <button class="btn-copy" onclick="copyLesson()"><i class="fas fa-copy"></i> Copy</button>
        <button class="btn-pdf" onclick="downloadPDF()"><i class="fas fa-download"></i> Download PDF</button>
    </div>

    <div id="lessonContent">Loading lesson...</div>
</div>

<div id="toast" class="toast"></div>

<script>
const lessonContent = document.getElementById("lessonContent");
const toast = document.getElementById("toast");

function showToast(message, success=true){
    toast.textContent = message;
    toast.style.background = success ? "#4caf50" : "#f44336";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),3000);
}

function goBack(){
    window.location.href = "../profile.html";
}

// Load lesson plan
async function loadLesson(){
    try{
        const planId = localStorage.getItem("fetched_plan_id");
        if(!planId) throw new Error("No lesson selected");

        const res = await fetch(`/.netlify/functions/get-single-plan?id=${planId}`);
        if(!res.ok) throw new Error("Failed to fetch lesson plan");

        const plan = await res.json();

        // Inject lesson HTML content
        lessonContent.innerHTML = plan.lesson_content || "<p>No content available</p>";

        // Store lesson title for PDF
        localStorage.setItem("lesson_title", plan.lesson_title || "lesson_plan");

    }catch(err){
        lessonContent.innerText = "Failed to load lesson.";
        showToast(err.message, false);
        console.error(err);
    }
}

// Copy lesson
async function copyLesson(){
    try{
        await navigator.clipboard.writeText(lessonContent.innerText);
        showToast("Lesson copied to clipboard!");
    }catch{
        showToast("Failed to copy lesson", false);
    }
}

// Download full lesson as PDF using html2pdf (handles long tables)
function downloadPDF(){
    const element = lessonContent;
    const opt = {
        margin: 10,
        filename: (localStorage.getItem("lesson_title") || "lesson_plan") + ".pdf",
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
    showToast("Lesson downloaded as PDF!");
}

document.addEventListener("DOMContentLoaded", loadLesson);
</script>

</body>
</html>
