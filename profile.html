<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fila Assistant – Profile</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root {
    --primary: #4caf50;
    --danger: #f44336;
    --bg: #f4f6f8;
    --card: #ffffff;
    --text: #333;
}

* { box-sizing: border-box; }

body {
    margin:0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* HEADER */
header {
    background:#fff;
    padding:15px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
}

header h1 { font-size:1.4rem; margin:0; }
header button {
    background: var(--danger);
    color:#fff;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
}

/* CONTAINER */
.profile-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 15px;
}

/* PROFILE CARD */
.profile-card {
    background: var(--card);
    border-radius:12px;
    padding:20px;
    display:flex;
    gap:20px;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    flex-wrap: wrap;
}

.avatar {
    width:90px;
    height:90px;
    border-radius:50%;
    background: var(--primary);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-size:34px;
    font-weight:bold;
}

.profile-details div { margin-bottom:6px; font-size:.95rem; }

/* PLANS SECTION */
.plans-section { margin-top:30px; }
.plans-section h2 { margin-bottom:15px; }

.plan-card {
    background: var(--card);
    border-radius:10px;
    padding:15px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.plan-title { font-weight:600; }
.plan-actions button {
    border:none;
    padding:7px 12px;
    border-radius:6px;
    cursor:pointer;
    font-size:.85rem;
    margin-left:5px;
}

.view-btn { background:#2196f3; color:#fff; }
.download-btn { background:var(--primary); color:#fff; }
.delete-btn { background:var(--danger); color:#fff; }

/* TOAST */
.toast {
    position: fixed;
    top:20px;
    right:20px;
    background: var(--primary);
    color:#fff;
    padding:10px 18px;
    border-radius:6px;
    opacity:0;
    transition:.3s;
    z-index:999;
}
.toast.show { opacity:1; }

/* RESPONSIVE */
@media(max-width:600px){
    header h1 { font-size:1.1rem; }
    .plan-card { flex-direction:column; align-items:flex-start; }
    .plan-actions { width:100%; display:flex; justify-content:flex-end; }
}
</style>
</head>

<body>

<header>
    <h1>Fila Assistant – Profile</h1>
    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<div class="profile-container">

    <!-- PROFILE CARD -->
    <div class="profile-card">
        <div class="avatar" id="avatar">--</div>
        <div class="profile-details">
            <div><strong>Name:</strong> <span id="fullName">Loading...</span></div>
            <div><strong>Email:</strong> <span id="email">Loading...</span></div>
            <div><strong>Phone:</strong> <span id="phone">Loading...</span></div>
        </div>
    </div>

    <!-- LESSON PLANS -->
    <div class="plans-section">
        <h2>Saved Lesson Plans</h2>
        <div id="plansList">Loading lesson plans…</div>
    </div>

</div>

<div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    const authToken = localStorage.getItem("auth_token");
    const userEmail = localStorage.getItem("user_email");

    if (!authToken || !userEmail) {
        location.href = "login.html";
        return;
    }

    const fullName = document.getElementById("fullName");
    const email = document.getElementById("email");
    const phone = document.getElementById("phone");
    const avatar = document.getElementById("avatar");
    const plansList = document.getElementById("plansList");
    const toast = document.getElementById("toast");

    function showToast(msg, ok=true){
        toast.textContent = msg;
        toast.style.background = ok ? "#4caf50" : "#f44336";
        toast.classList.add("show");
        setTimeout(()=>toast.classList.remove("show"),3000);
    }

    function initials(name){
        if(!name) return "--";
        return name.split(" ").map(w=>w[0]).slice(0,2).join("").toUpperCase();
    }

    // FETCH PROFILE
    try{
        const res = await fetch(`/.netlify/functions/get-user-profile?email=${userEmail}`);
        const data = await res.json();
        fullName.textContent = data.name || "N/A";
        email.textContent = data.email || "N/A";
        phone.textContent = data.phone || "N/A";
        avatar.textContent = initials(data.name);
    }catch{
        showToast("Failed to load profile", false);
    }

    // FETCH LESSON PLANS
    try{
        const res = await fetch(`/.netlify/functions/get-user-plans?email=${userEmail}`);
        const plans = await res.json();

        if(!plans.length){
            plansList.innerHTML = "<p>No lesson plans saved yet.</p>";
            return;
        }

        plansList.innerHTML = "";
        plans.forEach(plan=>{
            const div = document.createElement("div");
            div.className="plan-card";
            div.innerHTML=`
                <div class="plan-title">${plan.lesson_title}</div>
                <div class="plan-actions">
                    <button class="view-btn" onclick="viewPlan('${plan.id}')">View</button>
                    <button class="delete-btn" onclick="deletePlan('${plan.id}', this)">Delete</button>
                </div>`;
            plansList.appendChild(div);
        });
    }catch{
        plansList.innerHTML="<p>Error loading lesson plans.</p>";
        showToast("Failed to load lesson plans", false);
    }

    // VIEW PLAN
    window.viewPlan = async (id)=>{
        try{
            const res = await fetch(`/.netlify/functions/get-single-plan?id=${id}`);
            if(!res.ok) throw new Error("Plan not found");
            const plan = await res.json();
            localStorage.setItem("view_lesson_html", plan.lesson_content);
            localStorage.setItem("view_lesson_text", plan.lesson_text);
            localStorage.setItem("view_lesson_title", plan.lesson_title);
            localStorage.setItem("fetched_plan_id", plan.id);
            location.href="lesson_plan/view.html";
        }catch(err){
            showToast("Failed to load lesson", false);
        }
    };

    // DOWNLOAD PLAN AS TXT
    window.downloadPlan = async (id)=>{
        try{
            const res = await fetch(`/.netlify/functions/get-single-plan?id=${id}`);
            if(!res.ok) throw new Error("Plan not found");
            const plan = await res.json();
            const blob = new Blob([plan.lesson_text], {type:"text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = plan.lesson_title+".txt";
            a.click();
            showToast("Lesson downloaded");
        }catch{
            showToast("Failed to download", false);
        }
    };

    // DELETE PLAN
    window.deletePlan = async (id, btn)=>{
        try{
            await fetch(`/.netlify/functions/delete-plan?id=${id}`, {method:"DELETE"});
            btn.closest(".plan-card").remove();
            showToast("Lesson deleted");
        }catch{
            showToast("Failed to delete", false);
        }
    };

    // LOGOUT
    document.getElementById("logoutBtn").onclick=()=>{
        localStorage.clear();
        location.href="login.html";
    };
});
</script>

</body>
</html>
