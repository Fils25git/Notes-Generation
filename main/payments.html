<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; margin:0; }
    h1 { margin-bottom:20px; color:#333; text-align:center; }
    .card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; overflow-x:auto; }
    .summary { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-bottom:20px; }
    .summary div { flex:1 1 150px; background:#2980b9; color:#fff; padding:15px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; min-width:500px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#2980b9; color:#fff; }
    tr:nth-child(even) { background:#f9f9f9; }
    .section-title { margin-top:30px; margin-bottom:10px; color:#555; text-align:center; }
    #error { text-align:center; color:#e74c3c; font-weight:bold; margin-top:20px; }
    .btn-edit {
  background: #f39c12;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 5px;
}

.btn-delete {
  background: #e74c3c;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
                    }
    
/* CONTAINER */
.profile-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 15px;
}

/* PROFILE CARD */
.profile-card {
    background: var(--card);
    border-radius:12px;
    padding:20px;
    display:flex;
    gap:20px;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    flex-wrap: wrap;
  }
  </style>
</head>
<body>
  
<div class="profile-container">
   <div class="profile-card">
        <div class="avatar" id="avatar">--</div>
        <div class="profile-details">
            <div><strong>Name:</strong> <span id="fullName">Loading...</span></div>
            <div><strong>Email:</strong> <span id="email">Loading...</span></div>
            <div><strong>Phone:</strong> <span id="phone">Loading...</span></div>
        </div>
   </div>

<h1>User Payments</h1>

<div id="error"></div>

<!-- Summary Cards -->
<div class="summary">
  <div>
    <h3>Total Paid</h3>
    <p id="totalPaid">0</p>
  </div>
  <div>
    <h3>Remaining Daily Plans</h3>
    <p id="dailyPlans">0</p>
  </div>
  <div>
    <h3>Remaining Weekly Plans</h3>
    <p id="weeklyPlans">0</p>
  </div>
  <div>
    <h3>Balance Remaining</h3>
    <p id="balanceRemaining">0</p>
  </div>
</div>

<!-- Daily Payments Table -->
<h2 class="section-title">Daily Lesson Payments</h2>
<div class="card">
  <table id="dailyPaymentsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Amount</th>
        <th>Lessons Purchased</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading daily payments...</td></tr>
    </tbody>
  </table>
</div>

<!-- Weekly Payments Table -->
<h2 class="section-title">Weekly Plan Payments</h2>
<div class="card">
  <table id="weeklyPaymentsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Amount</th>
        <th>Lessons/Plans</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading weekly payments...</td></tr>
    </tbody>
  </table>
</div>
    
<script>
const params = new URLSearchParams(window.location.search);
const userId = params.get("user");

if (!userId) {
  alert("No user selected.");
  throw new Error("No user selected.");
}

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const fullName = document.getElementById("fullName");
    const emailEl = document.getElementById("email");
    const phoneEl = document.getElementById("phone");
    const avatar = document.getElementById("avatar");
    const toast = document.getElementById("toast");

    function showToast(msg, ok = true) {
      toast.textContent = msg;
      toast.style.background = ok ? "#4caf50" : "#f44336";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function initials(name) {
      if (!name) return "--";
      return name.split(" ").map(w => w[0]).slice(0, 2).join("").toUpperCase();
    }

    // -----------------------
    // 1️⃣ FETCH USER PROFILE
    // -----------------------
    try {
      const res = await fetch(`/.netlify/functions/get-user-profile?user=${userId}`);
      const data = await res.json();

      fullName.textContent = data.name || "N/A";
      emailEl.textContent = data.email || "N/A";
      phoneEl.textContent = data.phone || "N/A";
      avatar.textContent = initials(data.name);
    } catch {
      showToast("Failed to load profile", false);
    }

    // -----------------------
    // 2️⃣ FETCH PLAN SUMMARY
    // -----------------------
    try {
      const summaryRes = await fetch(`/.netlify/functions/get-user-plan-summary-remaining?user=${userId}`);
      const summaryData = await summaryRes.json();

      document.getElementById("totalPaid").textContent = summaryData.totals.totalPaid || 0;
      document.getElementById("dailyPlans").textContent = summaryData.totals.remainingDaily || 0;
      document.getElementById("weeklyPlans").textContent = summaryData.totals.remainingWeekly || 0;
      document.getElementById("balanceRemaining").textContent = summaryData.totals.balanceRemaining || 0;
    } catch {
      showToast("Failed to load plan summary", false);
    }

    // -----------------------
    // 3️⃣ FETCH DAILY PAYMENTS
    // -----------------------
    try {
      const dailyRes = await fetch(`/.netlify/functions/get-user-payments?user=${userId}`);
      const dailyPayments = await dailyRes.json();
      const dailyTableBody = document.querySelector("#dailyPaymentsTable tbody");

      if (!Array.isArray(dailyPayments) || dailyPayments.length === 0) {
        dailyTableBody.innerHTML = `<tr><td colspan="6">No daily payments found.</td></tr>`;
      } else {
        dailyTableBody.innerHTML = dailyPayments.map((p, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${p.amount || 0}</td>
            <td>${p.lessons || 0}</td>
            <td>${p.status || "N/A"}</td>
            <td>${p.payment_method || "N/A"}</td>
            <td>${new Date(p.created_at).toLocaleString() || "N/A"}</td>
          </tr>
        `).join("");
      }
    } catch {
      showToast("Failed to load daily payments", false);
    }

    // -----------------------
    // 4️⃣ FETCH WEEKLY PAYMENTS
    // -----------------------
    try {
      const weeklyRes = await fetch(`/.netlify/functions/get-user-weekly-payments?user=${userId}`);
      const weeklyPayments = await weeklyRes.json();
      const weeklyTableBody = document.querySelector("#weeklyPaymentsTable tbody");

      if (!Array.isArray(weeklyPayments) || weeklyPayments.length === 0) {
        weeklyTableBody.innerHTML = `<tr><td colspan="6">No weekly payments found.</td></tr>`;
      } else {
        weeklyTableBody.innerHTML = weeklyPayments.map((p, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${p.amount || 0}</td>
            <td>${p.lessons || 0}</td>
            <td>${p.status || "N/A"}</td>
            <td>${p.payment_method || "N/A"}</td>
            <td>${p.created_at ? new Date(p.created_at).toLocaleString() : "N/A"}</td>
          </tr>
        `).join("");
      }
    } catch {
      showToast("Failed to load weekly payments", false);
    }

  } catch (err) {
    console.error(err);
    alert("Error loading payments data. Please try again.");
  }
});
</script>
</body>
</html>
