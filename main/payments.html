<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; margin:0; }
    h1 { margin-bottom:20px; color:#333; text-align:center; }
    .card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; overflow-x:auto; }
    .summary { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-bottom:20px; }
    .summary div { flex:1 1 150px; background:#2980b9; color:#fff; padding:15px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; min-width:500px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#2980b9; color:#fff; }
    tr:nth-child(even) { background:#f9f9f9; }
    .section-title { margin-top:30px; margin-bottom:10px; color:#555; text-align:center; }
    #error { text-align:center; color:#e74c3c; font-weight:bold; margin-top:20px; }
    .btn-edit {
  background: #f39c12;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 5px;
}

.btn-delete {
  background: #e74c3c;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
                    }
  </style>
</head>
<body>

<h1>User Payments</h1>

<div id="error"></div>

<!-- Summary Cards -->
<div class="summary">
  <div>
    <h3>Total Paid</h3>
    <p id="totalPaid">0</p>
  </div>
  <div>
    <h3>Remaining Daily Plans</h3>
    <p id="dailyPlans">0</p>
  </div>
  <div>
    <h3>Remaining Weekly Plans</h3>
    <p id="weeklyPlans">0</p>
  </div>
  <div>
    <h3>Balance Remaining</h3>
    <p id="balanceRemaining">0</p>
  </div>
</div>

<!-- Daily Payments Table -->
<h2 class="section-title">Daily Lesson Payments</h2>
<div class="card">
  <table id="dailyPaymentsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Amount</th>
        <th>Lessons Purchased</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading daily payments...</td></tr>
    </tbody>
  </table>
</div>

<!-- Weekly Payments Table -->
<h2 class="section-title">Weekly Plan Payments</h2>
<div class="card">
  <table id="weeklyPaymentsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Amount</th>
        <th>Lessons/Plans</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading weekly payments...</td></tr>
    </tbody>
  </table>
</div>
<script>
const params = new URLSearchParams(window.location.search);
const userId = params.get("user");

if (!userId) {
  alert("No user selected.");
  throw new Error("No user selected.");
}

document.addEventListener("DOMContentLoaded", async () => {
  try {
    // -----------------------
    // 1️⃣ Fetch summary
    // -----------------------
    const summaryRes = await fetch(`/.netlify/functions/get-user-plan-summary-remaining?user=${userId}`);
    const summaryData = await summaryRes.json();

    document.getElementById("totalPaid").textContent = summaryData.totals.totalPaid;
    document.getElementById("dailyPlans").textContent = summaryData.totals.remainingDaily;
    document.getElementById("weeklyPlans").textContent = summaryData.totals.remainingWeekly;
    document.getElementById("balanceRemaining").textContent = summaryData.totals.balanceRemaining;

    // -----------------------
    // 2️⃣ Fetch daily payments
    // -----------------------
    const dailyRes = await fetch(`/.netlify/functions/get-user-payments?user=${userId}`);
    const dailyPayments = await dailyRes.json();
    const dailyTableBody = document.querySelector("#dailyPaymentsTable tbody");

    if (!Array.isArray(dailyPayments) || dailyPayments.length === 0) {
      dailyTableBody.innerHTML = `<tr><td colspan="7">No daily payments found.</td></tr>`;
    } else {
      dailyTableBody.innerHTML = dailyPayments.map((p, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${p.amount}</td>
          <td>${p.lessons}</td>
          <td>${p.status}</td>
          <td>${new Date(p.created_at).toLocaleString()}</td>
          <td>
            <button class="btn-edit" onclick="editPayment('${p.id}', 'daily')">Edit</button>
            <button class="btn-delete" onclick="deletePayment('${p.id}', 'daily')">Delete</button>
          </td>
        </tr>
      `).join("");
    }

    // -----------------------
    // 3️⃣ Fetch weekly payments
    // -----------------------
    const weeklyRes = await fetch(`/.netlify/functions/get-user-weekly-payments?user=${userId}`);
    const weeklyPayments = await weeklyRes.json();
    const weeklyTableBody = document.querySelector("#weeklyPaymentsTable tbody");

    if (!Array.isArray(weeklyPayments) || weeklyPayments.length === 0) {
      weeklyTableBody.innerHTML = `<tr><td colspan="7">No weekly payments found.</td></tr>`;
    } else {
      weeklyTableBody.innerHTML = weeklyPayments.map((p, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${p.amount_rwf}</td>
          <td>${p.plans_purchased}</td>
          <td>${p.payment_status}</td>
          <td>${new Date(p.payment_date).toLocaleString()}</td>
          <td>
            <button class="btn-edit" onclick="editPayment('${p.id}', 'weekly')">Edit</button>
            <button class="btn-delete" onclick="deletePayment('${p.id}', 'weekly')">Delete</button>
          </td>
        </tr>
      `).join("");
    }

  } catch (err) {
    console.error(err);
    alert("Error loading payments data. Please try again.");
  }
});

// -----------------------
// 4️⃣ Edit/Delete functions
// -----------------------
async function deletePayment(paymentId, type) {
  if (!confirm("Are you sure you want to delete this payment?")) return;

  const endpoint = type === 'daily'
    ? `/.netlify/functions/delete-daily-payment?id=${paymentId}`
    : `/.netlify/functions/delete-weekly-payment?id=${paymentId}`;

  try {
    const res = await fetch(endpoint, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      alert("Payment deleted successfully");
      location.reload(); // refresh table
    } else {
      alert("Error: " + (data.message || "Could not delete"));
    }
  } catch (err) {
    console.error(err);
    alert("Server error while deleting payment");
  }
}

async function editPayment(paymentId, type) {
  const newStatus = prompt("Enter new status (approved/pending/failed):");
  if (!newStatus) return;

  const endpoint = type === 'daily'
    ? `/.netlify/functions/edit-daily-payment`
    : `/.netlify/functions/edit-weekly-payment`;

  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: paymentId, status: newStatus })
    });
    const data = await res.json();
    if (data.success) {
      alert("Payment updated successfully");
      location.reload(); // refresh table
    } else {
      alert("Error: " + (data.message || "Could not update"));
    }
  } catch (err) {
    console.error(err);
    alert("Server error while updating payment");
  }
}
</script>
</body>
</html>
