<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila Assistant - CBC Lesson Plan Generator</title>
    <meta property="og:type" content="website" />
<meta property="og:title" content="Fila Assistant" />
<meta property="og:description" content=" Fila Assistant is an educational website that offers a wide range of educational resources, including Lesson Plans, and study guides for teachers and students across primary and secondary education" />
<meta property="og:image" content="https://www.fleduacademy.com/../logo.png" />
<meta property="og:url" content="https://www.fleduacademy.com" />
    
    <link rel="stylesheet" href="plans.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        .profile-icon {
    font-size:28px; color:#4f46e5; cursor:pointer;
}
        Responsive footer */
  footer {
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
    color: #fff;
    width: 100%;
  }
  footer a {
    color: #fff;
    text-decoration: underline;
    margin: 0 5px;
      }
      
        body{
            background: linear-gradient(135deg, #6dd5fa, #2980b9);
        }
      .floating-message {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #e74c3c;
        color: #fff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;
        animation: slideIn 0.6s ease;
        max-width: 300px;
        line-height: 1.6;
      }
        #lessonPlanContent[contenteditable="true"] {
    border: 2px dashed #007bff;
    background: #f8fbff;
    padding: 15px;
        }

      @keyframes slideIn {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .floating-message a {
        color: #fff;
        text-decoration: underline;
        font-weight: bold;
      }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
  <div class="header">
    <div class="header-left">
        <img src="../logo.png">
        <h2>Fila Assistant</h2>
    </div>

    <!-- Profile Icon (fixed right) -->
    <i id="profileIcon"
       class="fas fa-user-circle profile-icon"
       onclick="go('../profile.html')"
       title="My Profile">
    </i>
</div>
   
    <!-- Form -->
    <div class="form-container">
        <p><b>Fill in the required fields below To Fetch Lesson Plan For Nursery</b></p><br>
        <form id="lessonForm">
            <div class="form-grid">

                <!-- ‚úÖ Language selection -->
                <div class="form-group">
                    <label class="required">Select Language/Hitamo Ururimi</label>
                    <select id="language" required>
                        <option value="">Select Language</option>
                        <option value="english">English</option>
                        <option value="kinyarwanda">Kinyarwanda</option>
                      <!--  <option value="kiswahili">Kiswahili</option>-->
                        <!--<option value="french">French</option>-->
                    </select>
                </div>

                <div class="form-group">
                    <label class="required">Izina ry'ikigo/School Name</label>
                    <input type="text" id="schoolName" placeholder="e.g:,EP KABIRIZI"  required>
                </div>

                <div class="form-group">
                    <label class="required">Amazina ya Mwarimu/Teacher's Name</label>
                    <input type="text" id="teacherName" placeholder="e.g:, IRATURINZE Fils Lambert" required>
                </div>

                <div class="form-group">
                    <label class="required">Term</label>
                    <select id="term" required>
                        <option value="">Select Term/Hitamo igihembwe</option>
                        <option value="I">Term I</option>
                        <option value="II">Term II</option>
                        <option value="III">Term III</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="optional">Itariki/Date</label>
                    <input type="date" id="date">
                </div>

                <div class="form-group">
                    <label class="required">Ikigwa/Activity</label>
                    <input type="text" id="subject" placeholder="e.g:, English" required>
                </div>

                <div class="form-group">
                    <label class="required">Umwaka wa/Class</label>
                    <input type="text" id="class" placeholder="e.g:, N1, N2A" required>
                </div>

                <div class="form-group">
                    <label class="required">Umutwe wa/Unit No</label>
                    <input type="number" id="unitNo" placeholder="e.g:, 4" required>              </div>

                <div class="form-group">
                    <label class="required"> Isomo rya(Lesson No)/Muri(Total)</label>
                    <div class="double-input">
                        <input type="number" id="lessonNo" placeholder="e.g:, 4" required>
                        <input type="number" id="totalLessons" placeholder="e.g:, 10" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required"> Igihe isomo rimara/ Duration (minutes)</label>
                    <input type="number" id="duration" placeholder=" e.g:, 40" required>
                </div>
                <div class="form-group">
                    <label class="required"> Igihe isomo rimara mu ntangiriro/ Mu isomo Nyirizina / no mu Musozo Duration for each part of lesson</label>
                    <div class="triple-input">
                    <input type="number" id="intMin" placeholder=" Mu ntangiriro/ for inteoduction  e.g:, 5" required>
                        <input type="number" id="devMin" placeholder=" Mu isomo nyirizina / for Development  e.g:, 10" required>
                        <input type="number" id="concMin" placeholder=" Mu Musozo/ for conclusion e.g:, 5" required>
                </div>
                </div>

                <div class="form-group">
                    <label class="optional">Umubare w'abanyeshuri/Class size</label>
                    <input type="number"  id="classSize" placeholder="e.g:, 35">
                </div>

                <div class="form-group full-width">
                    <label class="required">Umutwe/Unit Title</label>
                    <input type="text" id="unitTitle" placeholder="e.g:, Leisure and Sports" required>
                </div>
              <div class="form-group full-width">
                    <label class="required">Insanganyamatsiko y'icyumweru/Weekly Theme</label>
                    <input type="text" id="weeklyTheme" placeholder="e.g:,Umuryango" required>
              </div>
                
              <div class="form-group full-width">
                    <label class="required">Imitere y'aho isomo ribera/ Plan for this class</label>
                    <input type="text" id="classPlan" placeholder="e.g:, Mu ishuri bakorera mu matsinda ya 3" required>
              </div>

                <div class="form-group full-width">
                    <label class="required">Isomo/Lesson Title</label>
                    <input type="text" id="lessonTitle" placeholder="e.g:, Family members" required>
                </div>

                <!-- ‚úÖ Teaching materials optional -->
                <div class="form-group full-width">
                    <label class="optional">Imfashanyigisho/Teaching Materials (Optional)</label>
                    <input type="text" id="teachingMaterials" placeholder="E.g., Flashcards, Worksheets">
                </div>

                <div class="form-group full-width">
                    <label class="optional">Abafite ibyo bagenerwa byihariye (niba bahari)/Special Educational Needs (If available)</label>
                    <input type="text" id="specialNeeds" placeholder="e.g:, 3 slow learners">
                </div>

                <div class="form-group full-width">
                    <label class="optional">Ibitabo n'inyandiko byifashishijwe/References (Optional)</label>
                    <input type="text" id="references" placeholder="e.g:, Numeracy  book for N1">
                </div>

            </div>

            <button type="submit" class="generate-btn">Fetch Lesson Plan</button>
            <div id="errorMessage" class="error-message"></div>
        </form>
    </div>

    <!-- Result -->
    <div id="resultContainer" class="result-container">
        <div class="download-buttons">
            <button class="download-btn btn-word" onclick="copyToWord()">üìÑ Copy to Word</button>
            <button class="download-btn btn-pdf" onclick="window.print()">üìë Save as PDF/Print</button>
    <button id="editBtn" Class="download-btn">‚úèÔ∏è Edit</button>
    <button id="saveBtn" class="download-btn" disabled>üíæ Save</button>
            
        </div>
        <div id="lessonPlanContent" class="lesson-plan"></div>
        
    </div>
</div>

<div id="floatingMessage" class="floating-message"></div>


<!-- Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script>
    // ===============================
    // AUTH CHECK
    // ===============================
    const token = localStorage.getItem("auth_token");
    const userEmail = localStorage.getItem("user_email");

    if (!token || !userEmail) {
        window.location.href = "../login.html";
    }

    // ===============================
    // FLOATING MESSAGE
    // ===============================
    function showFloatingMessage(msg) {
        const box = document.getElementById("floatingMessage");
        box.innerHTML = msg;
        box.style.display = "block";
        setTimeout(() => box.style.display = "none", 8000);
    }

    // ===============================
    // PLAN FILES
    // ===============================
    // ===============================
// PLAN FILES
// ===============================
const planFolders = {
    english: "proposals",
    kinyarwanda: "kinyarwanda_plans"
    // Disabled languages are commented out
    // kiswahili: "kiswahili_plans",
    // french: "french_plans"
};

// ===============================
// GET NEXT PLAN FILE (ROTATION)
// ===============================
function getNextPlanFile(language, email) {
    // Only allow active languages
    const activeLangs = Object.keys(planFolders);
    if (!activeLangs.includes(language)) {
        language = "english"; // fallback if disabled language is somehow chosen
    }

    const folder = planFolders[language];

    // Total plans per language
    const totalPlans = language === "english" ? 5 : 10; // adjust if needed

    const storageKey = `last_plan_${language}_${email}`;
    let lastIndex = parseInt(localStorage.getItem(storageKey)) || 0;

    // Get next index
    let nextIndex = lastIndex + 1;

    // Restart rotation if exceeded total
    if (nextIndex > totalPlans) nextIndex = 1;

    // Save next index for next fetch
    localStorage.setItem(storageKey, nextIndex);

    // Return full path to plan file
    return `${folder}/plan${nextIndex}.html`;
}

// ===============================
// LANGUAGE DEFAULTS
// ===============================
function getLanguageDefaults(language, subject, classLevel) {
    const activeLangs = ["english", "kinyarwanda"]; // only active languages

    if (!activeLangs.includes(language)) language = "english"; // fallback

    return {
        specialNeeds: {
            english: "There is no learner with special educational needs.",
            kinyarwanda: "Nta munyeshuri ufite ibyo agenerwa by'ihariye."
        },
        teachingMaterials: {
            english: `Songs, ${subject} textbook, learner's book, teacher's guide.`,
            kinyarwanda: `Indirimbo, ${subject} igitabo cy'umunyeshuri ${classLevel}.`
        },
        references: {
            english: `${subject} learner‚Äôs book, REB curriculum.`,
            kinyarwanda: `${subject} igitabo cy'umunyeshuri.`
        }
    };
    }
    // ===============================
    // FORM SUBMIT
    // ===============================
    document.getElementById("lessonForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const btn = document.querySelector(".generate-btn");
        btn.disabled = true;
        btn.textContent = "Fetching...";

        try {
            const res = await fetch(`/.netlify/functions/get-balance?email=${userEmail}`);
            const data = await res.json();

            if (data.balance <= 0) {
                showFloatingMessage("‚ùå No lesson plans remaining.");
                btn.disabled = false;
                btn.textContent = "Fetch Lesson Plan";
                return;
            }

            await fetch("/.netlify/functions/use-lesson-plan", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail })
            });

            generateLessonPlan();

        } catch (err) {
            showFloatingMessage("‚ùå Network error.");
            btn.disabled = false;
            btn.textContent = "Fetch Lesson Plan";
        }
    });

    // ===============================
    // GENERATE + AUTO SAVE
    // ===============================
    function generateLessonPlan() {
    const language = document.getElementById("language").value || "english";

    const subjectVal   = document.getElementById("subject").value;
    const classVal     = document.getElementById("class").value;
    const intMinVal    = document.getElementById("intMin").value;
    const devMinVal    = document.getElementById("devMin").value;
    const concMinVal   = document.getElementById("concMin").value;
    const weeklyThemeVal = document.getElementById("weeklyTheme").value;
    const classPlanVal = document.getElementById("classPlan").value;

    const defaults = getLanguageDefaults(language, subjectVal, classVal);

    const data = {
        schoolName: document.getElementById("schoolName").value,
        teacherName: document.getElementById("teacherName").value,
        term: document.getElementById("term").value,
        date: document.getElementById("date").value,
        subject: subjectVal,
        class: classVal,
        unitNo: document.getElementById("unitNo").value,
        lessonNo: document.getElementById("lessonNo").value,
        totalLessons: document.getElementById("totalLessons").value,
        duration: document.getElementById("duration").value,
        classSize: document.getElementById("classSize").value,
        unitTitle: document.getElementById("unitTitle").value,
        lessonTitle: document.getElementById("lessonTitle").value,
        weeklyTheme: weeklyThemeVal,
        intMin: intMinVal,
        devMin: devMinVal,
        concMin: concMinVal,
        classPlan: classPlanVal,
        teachingMaterials: document.getElementById("teachingMaterials").value || defaults.teachingMaterials[language],
        specialNeeds: document.getElementById("specialNeeds").value || defaults.specialNeeds[language],
        references: document.getElementById("references").value || defaults.references[language]
    };


        fetch(getNextPlanFile(language, userEmail))
            .then(res => res.text())
            .then(template => {

                for (const key in data) {
    template = template
        .replace(new RegExp(`{{\\s*${key}\\s*}}`, "g"), data[key])
        .replace(new RegExp(`\\$\\{\\s*${key}\\s*\\}`, "g"), data[key]);
    }

                lessonPlanContent.innerHTML = template;
                resultContainer.classList.add("show");
                resultContainer.scrollIntoView({ behavior: "smooth" });

                // üî• AUTO SAVE TO DATABASE USING EMAIL ONLY
                autoSavePlan(template, language, data.lessonTitle);

            })
            .catch(() => {
                showFloatingMessage("‚ùå Failed to load lesson plan.");
            });
    }

    // ===============================
    // AUTO SAVE FUNCTION (DATABASE)
    // ===============================
    async function autoSavePlan(content, language, title) {
        try {
            const res = await fetch("/.netlify/functions/create-user-plan", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: userEmail,   // <-- use email instead of user_id
                    lesson_title: title,
                    lesson_content: content,
                    language
                })
            });

            const data = await res.json();

            if (!res.ok) {
                console.error("SAVE FAILED:", data);
                showFloatingMessage("‚ö†Ô∏è Lesson generated but not saved.");
            }

        } catch (err) {
            console.error("AUTO SAVE ERROR:", err);
        }
    }

    // ===============================
    // EDIT & COPY (UNCHANGED)
    // ===============================
    editBtn.addEventListener("click", () => {
        lessonPlanContent.contentEditable = true;
        editBtn.disabled = true;
        saveBtn.disabled = false;
    });

    saveBtn.addEventListener("click", () => {
        lessonPlanContent.contentEditable = false;
        editBtn.disabled = false;
        saveBtn.disabled = true;
    });

    function copyToWord() {
        const range = document.createRange();
        range.selectNode(lessonPlanContent);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        showFloatingMessage("Lesson Plan copied.");
    }
    function go(path) {
    window.location.href = path;
}
</script>

</body>
    </html>
